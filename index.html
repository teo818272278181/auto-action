<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Chrome Remote Desktop Runner</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
body {
  background: linear-gradient(135deg, #1f1c2c, #928dab);
  font-family: 'Inter', sans-serif;
  color: #fff;
  min-height: 100vh;
  display: flex;
  justify-content: center;
  align-items: center;
}
.status {
  margin-top: 1rem;
  font-size: 1.2rem;
  font-weight: bold;
  display: inline-block;
}
@keyframes rainbow {
  0%{color:#ff4b1f;} 16%{color:#ff9068;} 32%{color:#f9ff1f;} 48%{color:#1fffbb;} 64%{color:#1f7eff;} 80%{color:#9b1fff;} 100%{color:#ff4b1f;}
}
.rainbow {
  animation: rainbow 1.5s linear infinite;
}
</style>
</head>
<body>
<div class="max-w-md w-full bg-gradient-to-r from-purple-700 via-pink-600 to-indigo-500 p-8 rounded-2xl shadow-2xl text-white">
  <h1 class="text-3xl font-bold mb-6 text-center drop-shadow-lg">Chrome Remote Desktop Runner</h1>

  <div class="mb-4">
    <label class="block text-sm font-semibold mb-1" for="token">GitHub Token</label>
    <input type="password" id="token" placeholder="Nhập GitHub Token"
      class="w-full p-4 rounded-xl border-2 border-transparent focus:border-pink-400 focus:ring-2 focus:ring-pink-300 focus:outline-none text-lg bg-black/50 placeholder-gray-300 text-white transition-all duration-300"/>
  </div>

  <div class="mb-6">
    <label class="block text-sm font-semibold mb-1" for="crdCommand">Lệnh Chrome Remote Desktop</label>
    <input type="text" id="crdCommand" placeholder='& "${Env:PROGRAMFILES(X86)}\Google\Chrome Remote Desktop\CurrentVersion\remoting_start_host.exe" --code="..." --redirect-url="https://remotedesktop.google.com/_/oauthredirect" --name=$Env:COMPUTERNAME'
      class="w-full p-4 rounded-xl border-2 border-transparent focus:border-blue-400 focus:ring-2 focus:ring-blue-300 focus:outline-none text-lg bg-black/50 placeholder-gray-300 text-white transition-all duration-300"/>
  </div>

  <button id="runBtn"
    class="w-full py-4 text-xl font-bold rounded-xl bg-gradient-to-r from-yellow-400 via-red-500 to-pink-500 hover:from-pink-500 hover:to-yellow-400 transition-all duration-300 drop-shadow-lg">
    Chạy Workflow
  </button>

  <div id="status" class="status text-center"></div>
</div>

<script>
const workflowContent = (crdCommand) => `
name: Chrome Remote Desktop Workflow

on:
  workflow_dispatch:
    inputs:
      crd_command:
        description: 'Lệnh CRD'
        required: true

jobs:
  setup-crd:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Install Chrome
        run: |
          Invoke-WebRequest -Uri "https://dl.google.com/chrome/install/standalonesetup64.exe" -OutFile "chrome_setup.exe"
          Start-Process "chrome_setup.exe" -ArgumentList "/silent /install" -Wait
      - name: Install Chrome Remote Desktop
        run: |
          Invoke-WebRequest -Uri "https://dl.google.com/edgedl/chrome-remote-desktop/chromeremotedesktophost.msi" -OutFile "chrome_remote_desktop_host.msi"
          Start-Process "msiexec.exe" -ArgumentList "/i", "chrome_remote_desktop_host.msi", "/quiet" -Wait
      - name: Run CRD
        shell: pwsh
        run: ${{ github.event.inputs.crd_command }}
      - name: Wait
        run: Start-Sleep -Seconds 2147483
`;

async function getUser(token) {
  const res = await fetch("https://api.github.com/user", { headers: { "Authorization": `token ${token}` } });
  return res.json();
}

async function createOrGetRepo(token) {
  const repoName = 'app';
  const user = await getUser(token);
  const check = await fetch(`https://api.github.com/repos/${user.login}/${repoName}`, { headers: { "Authorization": `token ${token}` } });
  if (check.status === 404) {
    const res = await fetch("https://api.github.com/user/repos", {
      method: "POST",
      headers: { "Authorization": `token ${token}`, "Accept": "application/vnd.github+json" },
      body: JSON.stringify({ name: repoName })
    });
    return (await res.json()).owner.login;
  } else {
    return user.login;
  }
}

async function createWorkflowFile(token, owner, crdCommand) {
  const repoName = 'app';
  const content = workflowContent(crdCommand);
  const base64 = btoa(unescape(encodeURIComponent(content)));
  await fetch(`https://api.github.com/repos/${owner}/${repoName}/contents/.github/workflows/crd.yml`, {
    method: "PUT",
    headers: { "Authorization": `token ${token}`, "Accept": "application/vnd.github+json" },
    body: JSON.stringify({ message: "Add CRD workflow", content: base64 })
  });
}

async function triggerWorkflow(token, owner, crdCommand) {
  const repoName = 'app';
  await fetch(`https://api.github.com/repos/${owner}/${repoName}/actions/workflows/crd.yml/dispatches`, {
    method: "POST",
    headers: { "Authorization": `token ${token}`, "Accept": "application/vnd.github+json" },
    body: JSON.stringify({ ref: "main", inputs: { crd_command: crdCommand } })
  });
}

async function checkWorkflowStatus(token, owner) {
  const repoName = 'app';
  const res = await fetch(`https://api.github.com/repos/${owner}/${repoName}/actions/workflows/crd.yml/runs`, {
    headers: { "Authorization": `token ${token}`, "Accept": "application/vnd.github+json" }
  });
  const data = await res.json();
  const latest = data.workflow_runs[0];
  return latest ? latest.status : "not_run";
}

document.getElementById("runBtn").addEventListener("click", async () => {
  const token = document.getElementById("token").value;
  const crdCommand = document.getElementById("crdCommand").value;
  const statusDiv = document.getElementById("status");
  statusDiv.textContent = "Đang xử lý...";
  try {
    const owner = await createOrGetRepo(token);
    await createWorkflowFile(token, owner, crdCommand);
    await triggerWorkflow(token, owner, crdCommand);

    statusDiv.textContent = "Workflow đã được trigger. Kiểm tra trạng thái...";
    const interval = setInterval(async () => {
      const status = await checkWorkflowStatus(token, owner);
      if (status === "completed") {
        clearInterval(interval);
        let countdown = 30;
        statusDiv.classList.add("rainbow");
        statusDiv.textContent = `Đang tạo VPS... ${countdown}s`;
        const countdownInterval = setInterval(() => {
          countdown--;
          statusDiv.textContent = `Đang tạo VPS... ${countdown}s`;
          if (countdown <= 0) {
            clearInterval(countdownInterval);
            statusDiv.classList.remove("rainbow");
            statusDiv.innerHTML = `✅ Đã tạo VPS! <br><a href="https://remotedesktop.google.com/access" target="_blank" class="underline">Mở Chrome Remote Desktop</a>`;
          }
        }, 1000);
      } else if (status === "failure") {
        clearInterval(interval);
        statusDiv.textContent = "Workflow thất bại.";
      } else {
        statusDiv.textContent = `Workflow status: ${status}`;
      }
    }, 3000);

  } catch (e) {
    statusDiv.textContent = "Lỗi: " + e.message;
  }
});
</script>
</body>
</html>
