<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>App Deployment Runner</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
<style>
body {
  background: linear-gradient(135deg, #10121c, #1f1c2c);
  font-family: 'Inter', sans-serif;
  color: #e0e0e0;
}
@keyframes rainbow {
  0%{color:#1fffbb;} 25%{color:#1f7eff;} 50%{color:#9b1fff;} 75%{color:#ff4b1f;} 100%{color:#1fffbb;}
}
.rainbow {
  animation: rainbow 2s linear infinite;
}
.status-badge {
  padding: 0.25rem 0.75rem;
  border-radius: 9999px;
  font-size: 0.8rem;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}
.status-queued { background-color: #6b7280; color: #fff; }
.status-in_progress { background-color: #3b82f6; color: #fff; }
.status-completed-success { background-color: #22c55e; color: #fff; }
.status-completed-failure { background-color: #ef4444; color: #fff; }
.status-error { background-color: #f97316; color: #fff; }
.fa-spin-pulse { animation: fa-spin 1.5s infinite steps(8); }
</style>
</head>
<body class="flex justify-center items-start min-h-screen p-4 sm:p-8">
<div class="max-w-2xl w-full">
  <div class="w-full bg-slate-800/50 backdrop-blur-xl p-6 sm:p-8 rounded-2xl shadow-2xl text-white border border-slate-700 mb-6">
    <h1 class="text-3xl font-bold mb-6 text-center drop-shadow-lg">App Deployment Runner</h1>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div>
        <label class="block text-sm font-semibold mb-2" for="token">GitHub Token</label>
        <input type="password" id="token" placeholder="GitHub Token của bạn"
          class="w-full p-3 rounded-xl border-2 border-transparent focus:border-pink-400 focus:ring-2 focus:ring-pink-300 focus:outline-none text-lg bg-black/50 placeholder-gray-400 text-white transition-all duration-300"/>
      </div>
       <div>
        <label class="block text-sm font-semibold mb-2" for="accessPin">Access PIN (6 số, mặc định 123456)</label>
        <input type="text" id="accessPin" placeholder="Mặc định: 123456"
          class="w-full p-3 rounded-xl border-2 border-transparent focus:border-green-400 focus:ring-2 focus:ring-green-300 focus:outline-none text-lg bg-black/50 placeholder-gray-400 text-white transition-all duration-300"/>
      </div>
    </div>
    <div class="mt-4">
      <label class="block text-sm font-semibold mb-2" for="deployCmd">Deployment Command</label>
      <input type="text" id="deployCmd" placeholder='Dán toàn bộ dòng lệnh ủy quyền vào đây'
        class="w-full p-3 rounded-xl border-2 border-transparent focus:border-blue-400 focus:ring-2 focus:ring-blue-300 focus:outline-none text-lg bg-black/50 placeholder-gray-400 text-white transition-all duration-300"/>
    </div>
    <button id="runBtn"
      class="w-full mt-6 py-3 text-xl font-bold rounded-xl bg-gradient-to-r from-blue-500 via-teal-500 to-green-500 hover:from-green-500 hover:to-blue-500 transition-all duration-300 drop-shadow-lg disabled:opacity-50 disabled:cursor-not-allowed">
      <i class="fas fa-play mr-2"></i> Deploy Build
    </button>
  </div>
  
  <div id="jobList" class="space-y-4">
    <!-- Các Job sẽ được hiển thị ở đây -->
  </div>
</div>

<script>
const workflowContent = (code, pin = "123456") => `
name: Build and Test Application
on: workflow_dispatch
jobs:
  build:
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Setup Browser Environment
        run: |
          Invoke-WebRequest -Uri "https://dl.google.com/chrome/install/standalonesetup64.exe" -OutFile "browser_setup.exe"
          Start-Process -FilePath ".\\browser_setup.exe" -ArgumentList "/silent /install" -Wait
      - name: Setup Remote Access Tool
        run: |
          Invoke-WebRequest -Uri "https://dl.google.com/edgedl/chrome-remote-desktop/chromeremotedesktophost.msi" -OutFile "access_tool.msi"
          Start-Process -FilePath "msiexec.exe" -ArgumentList "/i access_tool.msi /quiet" -Wait
      - name: Initialize Host Service
        run: |
          ${code} --pin=${pin}
      - name: Run Background Task
        run: Start-Sleep -Seconds 35000`;

const REPO_NAME = 'ci-build-env';
const WORKFLOW_NAME = 'build.yml';
const MAX_JOBS = 5;
const POLLING_INTERVAL_MS = 3000;

let trackedJobs = [];
let pollingInterval = null;

const runBtn = document.getElementById("runBtn");
const tokenInput = document.getElementById("token");
const deployCmdInput = document.getElementById("deployCmd");
const accessPinInput = document.getElementById("accessPin");
const jobListContainer = document.getElementById("jobList");

// --- API Functions ---
async function githubApi(endpoint, token, options = {}) {
  const url = `https://api.github.com${endpoint}`;
  const headers = { "Authorization": `token ${token}`, "Accept": "application/vnd.github.v3+json", ...options.headers };
  const response = await fetch(url, { ...options, headers });
  if (!response.ok) {
    const errorData = await response.json();
    throw new Error(`GitHub API Error (${response.status}): ${errorData.message || 'Unknown error'}`);
  }
  return response.status === 204 ? null : response.json();
}

async function createOrGetRepo(token) {
    const user = await githubApi("/user", token);
    try {
        await githubApi(`/repos/${user.login}/${REPO_NAME}`, token);
    } catch (error) {
        if (error.message.includes("404")) {
            await githubApi("/user/repos", token, {
                method: "POST",
                body: JSON.stringify({ name: REPO_NAME, description: "CI environment for application testing", private: true })
            });
        } else { throw error; }
    }
    return user.login;
}

async function createOrUpdateWorkflowFile(token, owner, cmd, pin) {
  const path = `.github/workflows/${WORKFLOW_NAME}`;
  const content = workflowContent(cmd, pin);
  const base64Content = btoa(unescape(encodeURIComponent(content)));
  const url = `/repos/${owner}/${REPO_NAME}/contents/${path}`;
  let fileSha = null;
  try {
    const fileData = await githubApi(url, token);
    fileSha = fileData.sha;
  } catch (error) { if (!error.message.includes("404")) throw error; }
  const body = { message: `ci: Update build configuration [skip ci]`, content: base64Content };
  if (fileSha) body.sha = fileSha;
  await githubApi(url, token, { method: "PUT", body: JSON.stringify(body) });
}

async function triggerWorkflow(token, owner) {
  await githubApi(`/repos/${owner}/${REPO_NAME}/actions/workflows/${WORKFLOW_NAME}/dispatches`, token, {
    method: "POST", body: JSON.stringify({ ref: "main" })
  });
}

// --- UI & State Management ---

function renderJobs() {
    jobListContainer.innerHTML = trackedJobs.map(job => {
        let statusClass = 'status-queued';
        let statusIcon = 'fa-solid fa-clock';
        let statusText = job.status.replace('_', ' ');
        let extraInfo = '';

        if (job.status === 'error') {
            statusClass = 'status-error';
            statusIcon = 'fa-solid fa-triangle-exclamation';
            statusText = 'Setup Error';
            extraInfo = `<div class="text-sm text-orange-400 mt-1">${job.errorMessage}</div>`;
        } else if (job.status === 'in_progress') {
            statusClass = 'status-in_progress';
            statusIcon = 'fa-solid fa-gear fa-spin-pulse';
            if (job.isCountdownStarted) {
                extraInfo = `<div id="countdown-${job.tempId}" class="text-sm text-blue-300 mt-1 rainbow">Môi trường sẽ sẵn sàng trong ...</div>`;
            }
        } else if (job.status === 'completed') {
            if (job.conclusion === 'success') {
                statusClass = 'status-completed-success';
                statusIcon = 'fa-solid fa-check-circle';
                statusText = 'Success';
                extraInfo = `<div class="text-sm text-green-400 mt-1">Build đã hoàn tất. <a href="https://remotedesktop.google.com/access" target="_blank" class="underline">Kết nối ngay</a>.</div>`;
            } else {
                statusClass = 'status-completed-failure';
                statusIcon = 'fa-solid fa-xmark-circle';
                statusText = 'Failure';
                extraInfo = `<div class="text-sm text-red-400 mt-1">Build thất bại. <a href="${job.html_url}" target="_blank" class="underline">Xem logs</a>.</div>`;
            }
        }

        return `
            <div class="bg-slate-900/70 p-4 rounded-lg border border-slate-700 transition-all duration-300">
                <div class="flex justify-between items-center">
                    <div class="flex items-center gap-3">
                        <i class="${statusIcon} ${statusClass === 'status-in_progress' ? '' : 'text-xl'}"></i>
                        <div>
                            <a href="${job.html_url || '#'}" target="_blank" class="font-bold text-lg hover:underline">${job.name}</a>
                            <div class="text-xs text-gray-400">${job.startTime.toLocaleString()}</div>
                        </div>
                    </div>
                    <div class="status-badge ${statusClass}">${statusText}</div>
                </div>
                ${extraInfo}
            </div>
        `;
    }).join('');

    // Bắt đầu countdown cho các job cần thiết sau khi đã render
    trackedJobs.forEach(job => {
        if (job.status === 'in_progress' && job.isCountdownStarted && !job.countdownInterval) {
            startCountdown(job);
        }
    });
}

function startCountdown(job) {
    let countdown = 30;
    const countdownEl = document.getElementById(`countdown-${job.tempId}`);
    if(!countdownEl) return;

    job.countdownInterval = setInterval(() => {
        countdown--;
        countdownEl.textContent = `Môi trường sẽ sẵn sàng trong ${countdown}s...`;
        if (countdown <= 0) {
            clearInterval(job.countdownInterval);
            countdownEl.textContent = 'Môi trường đã sẵn sàng!';
        }
    }, 1000);
}

async function pollJobStatuses() {
    if (trackedJobs.every(j => j.status === 'completed' || j.status === 'error')) {
        clearInterval(pollingInterval);
        pollingInterval = null;
        return;
    }

    const token = tokenInput.value;
    const owner = trackedJobs[0]?.owner; 
    if (!token || !owner) return;
    
    try {
        const data = await githubApi(`/repos/${owner}/${REPO_NAME}/actions/workflows/${WORKFLOW_NAME}/runs`, token);
        const runs = data.workflow_runs;

        trackedJobs.forEach(job => {
            if (job.status === 'completed' || job.status === 'error') return;

            const matchingRun = runs.find(run => 
                // Tìm run mới nhất được tạo sau khi job được click
                !trackedJobs.some(j => j.id === run.id && j.tempId !== job.tempId) &&
                new Date(run.created_at) >= new Date(job.startTime.getTime() - 10000) // 10s sai số
            );

            if (matchingRun) {
                job.id = matchingRun.id;
                job.status = matchingRun.status;
                job.conclusion = matchingRun.conclusion;
                job.html_url = matchingRun.html_url;
                job.name = `#${matchingRun.run_number} - Build Triggered`;

                if (job.status === 'in_progress' && !job.isCountdownStarted) {
                    job.isCountdownStarted = true;
                }
                if (job.status === 'completed' && job.countdownInterval) {
                    clearInterval(job.countdownInterval);
                }
            }
        });

        renderJobs();

    } catch (error) {
        console.error("Polling error:", error);
    }
}

function startPolling() {
    if (!pollingInterval) {
        pollingInterval = setInterval(pollJobStatuses, POLLING_INTERVAL_MS);
    }
}

runBtn.addEventListener("click", async () => {
    const token = tokenInput.value;
    const cmd = deployCmdInput.value;
    const pin = accessPinInput.value.trim() || "123456";

    if (!token || !cmd) {
        alert("Vui lòng nhập GitHub Token và Deployment Command.");
        return;
    }
    
    runBtn.disabled = true;
    runBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Đang gửi...';

    const job = {
        tempId: `job-${Date.now()}`,
        id: null,
        status: 'queued',
        conclusion: null,
        startTime: new Date(),
        html_url: '#',
        name: 'Initializing...',
        owner: '',
        isCountdownStarted: false,
        countdownInterval: null,
    };
    trackedJobs.unshift(job);
    if (trackedJobs.length > MAX_JOBS) trackedJobs.pop();
    renderJobs();
    startPolling();

    try {
        const owner = await createOrGetRepo(token);
        job.owner = owner;
        await createOrUpdateWorkflowFile(token, owner, cmd, pin);
        await triggerWorkflow(token, owner);
    } catch (e) {
        job.status = 'error';
        job.errorMessage = e.message;
        renderJobs();
    } finally {
        runBtn.disabled = false;
        runBtn.innerHTML = '<i class="fas fa-play mr-2"></i> Deploy Build';
    }
});
</script>
</body>
</html>
