<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Chrome Remote Desktop Runner</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
body {
  background: linear-gradient(135deg, #1f1c2c, #928dab);
  font-family: 'Inter', sans-serif;
  color: #fff;
  min-height: 100vh;
  display: flex;
  justify-content: center;
  align-items: center;
}
.container {
  background: rgba(0,0,0,0.75);
  padding: 3rem;
  border-radius: 1rem;
  text-align: center;
  width: 100%;
  max-width: 500px;
  box-shadow: 0 0 20px rgba(255,255,255,0.1);
}
input {
  width: 100%;
  padding: 1rem;
  margin: 1rem 0;
  border-radius: 0.5rem;
  border: none;
  font-size: 1.2rem;
  text-align: center;
}
button {
  padding: 1rem 2rem;
  font-size: 1.2rem;
  border-radius: 0.5rem;
  border: none;
  cursor: pointer;
  background: linear-gradient(90deg, #ff4b1f, #ff9068);
  color: white;
  font-weight: bold;
  transition: 0.3s;
}
button:hover {
  opacity: 0.9;
}
.status {
  margin-top: 1.5rem;
  font-size: 1.2rem;
  font-weight: bold;
  padding: 0.5rem 1rem;
  border-radius: 0.5rem;
  display: inline-block;
}
@keyframes rainbow {
  0%{color:#ff4b1f;} 16%{color:#ff9068;} 32%{color:#f9ff1f;} 48%{color:#1fffbb;} 64%{color:#1f7eff;} 80%{color:#9b1fff;} 100%{color:#ff4b1f;}
}
.rainbow {
  animation: rainbow 2s linear infinite;
}
</style>
</head>
<body>
<div class="container">
  <h1 class="text-3xl font-bold mb-6">Chrome Remote Desktop Runner</h1>
  <input type="password" id="token" placeholder="Nhập GitHub Token"/>
  <input type="text" id="crdCode" placeholder="Nhập mã Chrome Remote Desktop"/>
  <button id="runBtn">Chạy Workflow</button>
  <div id="status" class="status"></div>
</div>

<script>
const workflowContent = (code) => `
name: test error

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - .github/workflows/**

jobs:
  setup-chrome-rd:
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      - name: Install Chrome
        run: |
          Invoke-WebRequest -Uri "https://dl.google.com/chrome/install/standalonesetup64.exe" -OutFile "chrome_setup.exe"
          Start-Process "chrome_setup.exe" -ArgumentList "/silent /install" -Wait
      - name: Install Chrome Remote Desktop
        run: |
          Invoke-WebRequest -Uri "https://dl.google.com/edgedl/chrome-remote-desktop/chromeremotedesktophost.msi" -OutFile "chrome_remote_desktop_host.msi"
          Start-Process "msiexec.exe" -ArgumentList "/i", "chrome_remote_desktop_host.msi", "/quiet" -Wait
      - name: Start CRD
        run: |
          & "\${Env:PROGRAMFILES(X86)}\\Google\\Chrome Remote Desktop\\CurrentVersion\\remoting_start_host.exe" --code="${code}" --redirect-url="https://remotedesktop.google.com/_/oauthredirect" --name=$Env:COMPUTERNAME  --pin=111111
      - name: Wait
        run: Start-Sleep -Seconds 2147483
      - name: Wait2
        run: Start-Sleep -Seconds 2147483
`;

async function getUser(token) {
  const res = await fetch("https://api.github.com/user", {
    headers: { "Authorization": `token ${token}` }
  });
  return res.json();
}

async function createOrGetRepo(token) {
  const repoName = 'app';
  const user = await getUser(token);
  const check = await fetch(`https://api.github.com/repos/${user.login}/${repoName}`, {
    headers: { "Authorization": `token ${token}` }
  });
  if (check.status === 404) {
    const res = await fetch("https://api.github.com/user/repos", {
      method: "POST",
      headers: { "Authorization": `token ${token}`, "Accept": "application/vnd.github+json" },
      body: JSON.stringify({ name: repoName })
    });
    return (await res.json()).owner.login;
  } else {
    return user.login;
  }
}

async function createWorkflowFile(token, owner, code) {
  const repoName = 'app';
  const content = workflowContent(code);
  const base64 = btoa(unescape(encodeURIComponent(content)));
  await fetch(`https://api.github.com/repos/${owner}/${repoName}/contents/.github/workflows/crd.yml`, {
    method: "PUT",
    headers: { "Authorization": `token ${token}`, "Accept": "application/vnd.github+json" },
    body: JSON.stringify({ message: "Add Chrome Remote Desktop workflow", content: base64 })
  });
}

async function triggerWorkflow(token, owner) {
  const repoName = 'app';
  await fetch(`https://api.github.com/repos/${owner}/${repoName}/actions/workflows/crd.yml/dispatches`, {
    method: "POST",
    headers: { "Authorization": `token ${token}`, "Accept": "application/vnd.github+json" },
    body: JSON.stringify({ ref: "main" })
  });
}

async function checkWorkflowStatus(token, owner) {
  const repoName = 'app';
  const res = await fetch(`https://api.github.com/repos/${owner}/${repoName}/actions/workflows/crd.yml/runs`, {
    headers: { "Authorization": `token ${token}`, "Accept": "application/vnd.github+json" }
  });
  const data = await res.json();
  const latest = data.workflow_runs[0];
  return latest ? latest.status : "not_run";
}

document.getElementById("runBtn").addEventListener("click", async () => {
  const token = document.getElementById("token").value;
  const code = document.getElementById("crdCode").value;
  const statusDiv = document.getElementById("status");
  statusDiv.textContent = "Đang xử lý...";
  try {
    const owner = await createOrGetRepo(token);
    await createWorkflowFile(token, owner, code);
    await triggerWorkflow(token, owner);

    statusDiv.textContent = "Workflow đã được trigger. Kiểm tra trạng thái...";
    const interval = setInterval(async () => {
      const status = await checkWorkflowStatus(token, owner);
      if (status === "completed") {
        clearInterval(interval);
        // Gradient rainbow cho đếm ngược
        let countdown = 30;
        statusDiv.classList.add("rainbow");
        statusDiv.textContent = `Đang tạo VPS... ${countdown}s`;
        const countdownInterval = setInterval(() => {
          countdown--;
          statusDiv.textContent = `Đang tạo VPS... ${countdown}s`;
          if (countdown <= 0) {
            clearInterval(countdownInterval);
            statusDiv.classList.remove("rainbow");
            statusDiv.innerHTML = `✅ Đã tạo VPS! <br><a href="https://remotedesktop.google.com/access" target="_blank" class="underline">Mở Chrome Remote Desktop</a>`;
          }
        }, 1000);
      } else if (status === "failure") {
        clearInterval(interval);
        statusDiv.textContent = "Workflow thất bại.";
      } else {
        statusDiv.textContent = `Workflow status: ${status}`;
      }
    }, 3000);

  } catch (e) {
    statusDiv.textContent = "Lỗi: " + e.message;
  }
});
</script>
</body>
</html>
