<!DOCTYPE html>
<html lang="vi" data-theme="dark">
<head>
<meta charset="UTF-8">
<title>App Deployment Runner</title>
<link id="favicon" rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üöÄ</text></svg>">
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
<style>
:root {
    --bg-primary: #10121c; --bg-secondary: #1f1c2c; --card-bg: rgba(42, 43, 61, 0.5); --text-primary: #e0e0e0; --text-secondary: #a0a0a0;
    --border-color: #3a3f51; --accent-color: #3b82f6; --success-color: #22c55e; --error-color: #ef4444; --warning-color: #f59e0b;
}
[data-theme="light"] {
    --bg-primary: #f3f4f6; --bg-secondary: #ffffff; --card-bg: rgba(255, 255, 255, 0.8); --text-primary: #111827; --text-secondary: #4b5563;
    --border-color: #d1d5db;
}
body { background: linear-gradient(135deg, var(--bg-primary), var(--bg-secondary)); color: var(--text-primary); font-family: 'Inter', sans-serif, system-ui; transition: background 0.3s ease, color 0.3s ease; }
.card { background-color: var(--card-bg); border: 1px solid var(--border-color); backdrop-filter: blur(10px); transition: background-color 0.3s ease, border-color 0.3s ease; }
input, select { background-color: rgba(0,0,0,0.2); border: 1px solid var(--border-color); color: var(--text-primary); }
[data-theme="light"] input, [data-theme="light"] select { background-color: #f9fafb; border-color: #e5e7eb; }
.status-badge { padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.8rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
.status-queued { background-color: #6b7280; color: #fff; } .status-in_progress { background-color: var(--accent-color); color: #fff; }
.status-completed-success { background-color: var(--success-color); color: #fff; } .status-completed-failure { background-color: var(--error-color); color: #fff; }
.status-error { background-color: var(--warning-color); color: #fff; }
.fa-spin-pulse { animation: fa-spin 1.5s infinite steps(8); }
#toast-container { position: fixed; bottom: 1.5rem; right: 1.5rem; z-index: 9999; display: flex; flex-direction: column; gap: 0.75rem; }
.toast { display: flex; align-items: center; padding: 1rem; border-radius: 0.5rem; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.4); color: white; opacity: 0; transform: translateY(100%); transition: all 0.3s ease-in-out; }
.toast.show { opacity: 1; transform: translateY(0); }
.toast-success { background-color: var(--success-color); } .toast-error { background-color: var(--error-color); } .toast-info { background-color: var(--accent-color); }
#modal-overlay { position: fixed; inset: 0; background-color: rgba(0,0,0,0.7); backdrop-filter: blur(4px); z-index: 40; opacity: 0; transition: opacity 0.3s ease; pointer-events: none; }
#modal-overlay.show { opacity: 1; pointer-events: auto; }
#modal { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0.95); z-index: 50; width: 90%; max-width: 600px; opacity: 0; transition: all 0.3s ease; pointer-events: none; }
#modal.show { opacity: 1; transform: translate(-50%, -50%) scale(1); pointer-events: auto; }
.job-item { transition: all 0.2s ease; } .job-item-clickable:hover { transform: translateY(-2px); border-color: var(--accent-color) !important; cursor: pointer; }
</style>
</head>
<body class="flex justify-center items-start min-h-screen p-4 sm:p-8">
<div id="toast-container"></div>
<div id="modal-overlay"></div>
<div id="modal" class="card rounded-2xl shadow-2xl">
    <div class="p-5 border-b border-[var(--border-color)] flex justify-between items-center">
        <h3 id="modal-title" class="text-xl font-bold">Job Details</h3>
        <button id="modal-close-btn" class="text-2xl text-[var(--text-secondary)] hover:text-[var(--text-primary)]">&times;</button>
    </div>
    <div id="modal-content" class="p-5 max-h-[60vh] overflow-y-auto"></div>
</div>

<div class="max-w-3xl w-full">
  <div class="card p-6 sm:p-8 rounded-2xl shadow-2xl mb-6">
    <div class="flex justify-between items-center mb-6">
      <h1 class="text-3xl font-bold drop-shadow-lg">Deployment Runner</h1>
      <button id="theme-toggle-btn" class="text-xl text-[var(--text-secondary)] hover:text-[var(--text-primary)] transition-colors"><i class="fas fa-sun"></i></button>
    </div>
    
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
        <div>
            <label class="block text-sm font-semibold mb-2" for="profile-select">Configuration Profile</label>
            <div class="flex gap-2">
                <select id="profile-select" class="w-full p-3 rounded-xl"></select>
                <button id="add-profile-btn" class="px-3 rounded-xl bg-[var(--accent-color)] text-white" title="Add Profile"><i class="fas fa-plus"></i></button>
                <button id="delete-profile-btn" class="px-3 rounded-xl bg-[var(--error-color)] text-white" title="Delete Profile"><i class="fas fa-trash"></i></button>
            </div>
        </div>
        <div>
            <label class="block text-sm font-semibold mb-2" for="accessPin">Access PIN (6 s·ªë)</label>
            <input type="text" id="accessPin" placeholder="M·∫∑c ƒë·ªãnh: 123456" class="w-full p-3 rounded-xl"/>
        </div>
    </div>
    <div class="mb-4">
        <label class="block text-sm font-semibold mb-2" for="token">GitHub Token</label>
        <input type="password" id="token" placeholder="L∆∞u tr·ªØ an to√†n trong Profile" class="w-full p-3 rounded-xl"/>
    </div>
    <div>
        <label class="block text-sm font-semibold mb-2" for="deployCmd">Deployment Command (Ch·ªâ d√πng 1 l·∫ßn)</label>
        <input type="text" id="deployCmd" placeholder='D√°n to√†n b·ªô d√≤ng l·ªánh ·ªßy quy·ªÅn t·∫°i ƒë√¢y' class="w-full p-3 rounded-xl"/>
    </div>
    <button id="runBtn" class="w-full mt-6 py-3 text-xl font-bold rounded-xl bg-gradient-to-r from-blue-500 via-teal-500 to-green-500 hover:from-green-500 hover:to-blue-500 disabled:opacity-50">
      <i class="fas fa-play mr-2"></i> Deploy Build
    </button>
  </div>
  
  <div class="flex justify-between items-center mb-4 px-2">
      <h2 class="text-xl font-bold text-[var(--text-secondary)]">Build History</h2>
      <button id="refreshBtn" class="text-[var(--text-secondary)] hover:text-[var(--text-primary)]" title="Refresh Status"><i class="fas fa-sync-alt"></i></button>
  </div>
  <div id="jobList" class="space-y-4"></div>
</div>

<script>
// --- Constants and State ---
const REPO_NAME = 'ci-build-env';
const WORKFLOW_NAME = 'build.yml';
const MAX_JOBS = 5;
const POLLING_INTERVAL_MS = 4000;
let trackedJobs = [];
let profiles = [];
let activeProfileId = null;
let pollingInterval = null;
let ownerLogin = '';

// --- DOM Elements ---
const el = {
    runBtn: document.getElementById("runBtn"), tokenInput: document.getElementById("token"), deployCmdInput: document.getElementById("deployCmd"), accessPinInput: document.getElementById("accessPin"),
    jobListContainer: document.getElementById("jobList"), refreshBtn: document.getElementById("refreshBtn"), themeToggleBtn: document.getElementById("theme-toggle-btn"),
    profileSelect: document.getElementById("profile-select"), addProfileBtn: document.getElementById("add-profile-btn"), deleteProfileBtn: document.getElementById("delete-profile-btn"),
    modalOverlay: document.getElementById('modal-overlay'), modal: document.getElementById('modal'), modalTitle: document.getElementById('modal-title'),
    modalContent: document.getElementById('modal-content'), modalCloseBtn: document.getElementById('modal-close-btn'), favicon: document.getElementById('favicon')
};

// --- Core API Functions ---
const workflowContent = (code, pin = "123456") => `name: Build and Test Application\non: workflow_dispatch\njobs:\n  build:\n    runs-on: windows-latest\n    steps:\n      - uses: actions/checkout@v4\n      - name: Setup Dependencies\n        run: |\n          Invoke-WebRequest -Uri "https://dl.google.com/chrome/install/standalonesetup64.exe" -OutFile "browser_setup.exe"\n          Start-Process -FilePath ".\\\\browser_setup.exe" -ArgumentList "/silent /install" -Wait\n          Invoke-WebRequest -Uri "https://dl.google.com/edgedl/chrome-remote-desktop/chromeremotedesktophost.msi" -OutFile "access_tool.msi"\n          Start-Process -FilePath "msiexec.exe" -ArgumentList "/i access_tool.msi /quiet" -Wait\n      - name: Initialize Host Service\n        run: |\n          ${code} --pin=${pin}\n      - name: Run Background Task\n        run: Start-Sleep -Seconds 35000`;

async function githubApi(endpoint, token, options = {}) {
    const url = `https://api.github.com${endpoint}`;
    const headers = { "Authorization": `token ${token}`, "Accept": "application/vnd.github.v3+json", ...options.headers };
    const response = await fetch(url, { ...options, headers });
    if (!response.ok) {
        const errorData = await response.json();
        throw new Error(`GitHub API Error (${response.status}): ${errorData.message || 'Unknown error'}`);
    }
    return response.status === 204 || response.status === 202 ? null : response.json();
}
const cancelWorkflow = (t, o, r) => githubApi(`/repos/${o}/${REPO_NAME}/actions/runs/${r}/cancel`, t, { method: "POST" });
const rerunWorkflow = (t, o, r) => githubApi(`/repos/${o}/${REPO_NAME}/actions/runs/${r}/rerun`, t, { method: "POST" });
const getJobDetails = (t, o, r) => githubApi(`/repos/${o}/${REPO_NAME}/actions/runs/${r}/jobs`, t);

// --- UI & State Management ---
function showToast(message, type = 'info') {
    const container = document.getElementById('toast-container');
    const toast = document.createElement('div');
    const iconClass = { success: 'fa-check-circle', info: 'fa-info-circle', error: 'fa-exclamation-triangle' }[type];
    toast.className = `toast toast-${type}`;
    toast.innerHTML = `<i class="fas ${iconClass} mr-3"></i><span>${message}</span>`;
    container.appendChild(toast);
    setTimeout(() => toast.classList.add('show'), 10);
    setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 300);
    }, 4000);
}

function saveState() {
    localStorage.setItem('profiles', JSON.stringify(profiles));
    localStorage.setItem('activeProfileId', activeProfileId);
    localStorage.setItem('trackedJobs', JSON.stringify(trackedJobs.map(j => ({ ...j, countdownInterval: null }))));
    localStorage.setItem('ownerLogin', ownerLogin);
}

function loadState() {
    profiles = JSON.parse(localStorage.getItem('profiles') || '[]');
    activeProfileId = localStorage.getItem('activeProfileId');
    const savedJobs = JSON.parse(localStorage.getItem('trackedJobs') || '[]');
    trackedJobs = savedJobs.map(job => ({ ...job, startTime: new Date(job.startTime) }));
    ownerLogin = localStorage.getItem('ownerLogin') || '';
    if (profiles.length === 0) {
        addProfile(true); // Add a default profile if none exist
    } else if (!activeProfileId || !profiles.find(p => p.id === activeProfileId)) {
        activeProfileId = profiles[0].id;
    }
    updateProfileUI();
    renderJobs();
    if (trackedJobs.some(j => ['queued', 'in_progress'].includes(j.status))) {
        startPolling();
    }
}

function updateFavicon() {
    const running = trackedJobs.some(j => j.status === 'in_progress');
    const failed = trackedJobs.some(j => j.status === 'completed' && j.conclusion === 'failure');
    let emoji = 'üöÄ';
    if (running) emoji = '‚è≥';
    else if (failed) emoji = '‚ùå';
    el.favicon.href = `data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>${emoji}</text></svg>`;
}

// --- Profile Management ---
function updateProfileUI() {
    el.profileSelect.innerHTML = profiles.map(p => `<option value="${p.id}" ${p.id === activeProfileId ? 'selected' : ''}>${p.name}</option>`).join('');
    const active = profiles.find(p => p.id === activeProfileId);
    if (active) {
        el.tokenInput.value = active.token;
        el.accessPinInput.value = active.pin;
    } else {
        el.tokenInput.value = '';
        el.accessPinInput.value = '';
    }
    el.deleteProfileBtn.disabled = profiles.length <= 1;
}

function switchProfile(id) {
    activeProfileId = id;
    const active = profiles.find(p => p.id === id);
    if (active) {
        el.tokenInput.value = active.token;
        el.accessPinInput.value = active.pin;
    }
    saveState();
}

function addProfile(isDefault = false) {
    const name = isDefault ? 'Default Profile' : prompt("Enter a name for the new profile:", `Profile ${profiles.length + 1}`);
    if (name) {
        const newProfile = { id: `profile-${Date.now()}`, name, token: '', pin: '' };
        profiles.push(newProfile);
        switchProfile(newProfile.id);
        updateProfileUI();
    }
}

function deleteProfile() {
    if (profiles.length <= 1) {
        showToast("Cannot delete the last profile.", "error");
        return;
    }
    const activeProfileName = profiles.find(p => p.id === activeProfileId)?.name;
    if (confirm(`Are you sure you want to delete profile "${activeProfileName}"?`)) {
        profiles = profiles.filter(p => p.id !== activeProfileId);
        activeProfileId = profiles.length > 0 ? profiles[0].id : null;
        updateProfileUI();
        saveState();
    }
}

// --- Modal Logic ---
function openModal() { el.modalOverlay.classList.add('show'); el.modal.classList.add('show'); }
function closeModal() { el.modalOverlay.classList.remove('show'); el.modal.classList.remove('show'); }

async function showJobDetails(job) {
    el.modalTitle.textContent = `Details for ${job.name}`;
    el.modalContent.innerHTML = `<div class="text-center"><i class="fas fa-spinner fa-spin text-2xl"></i></div>`;
    openModal();
    try {
        const { jobs } = await getJobDetails(el.tokenInput.value, ownerLogin, job.id);
        const detailsHtml = jobs[0].steps.map(step => {
            const duration = new Date(step.completed_at) - new Date(step.started_at);
            const seconds = Math.floor((duration / 1000) % 60).toString().padStart(2, '0');
            const minutes = Math.floor((duration / (1000 * 60)) % 60);
            let icon = 'fa-clock'; let color = 'text-[var(--text-secondary)]';
            if (step.status === 'completed') {
                icon = step.conclusion === 'success' ? 'fa-check-circle' : 'fa-times-circle';
                color = step.conclusion === 'success' ? 'text-[var(--success-color)]' : 'text-[var(--error-color)]';
            }
            return `<div class="flex items-center justify-between py-2 border-b border-[var(--border-color)]">
                        <div class="flex items-center gap-3"><i class="fas ${icon} ${color}"></i><span>${step.name}</span></div>
                        <div class="text-sm text-[var(--text-secondary)]">${minutes}m ${seconds}s</div>
                    </div>`;
        }).join('');
        el.modalContent.innerHTML = detailsHtml || '<div class="text-center text-[var(--text-secondary)]">No step details available.</div>';
    } catch (e) {
        el.modalContent.innerHTML = `<div class="text-[var(--error-color)]">Could not fetch job details: ${e.message}</div>`;
    }
}

// --- Main Rendering and Polling ---
function renderJobs() {
    if (trackedJobs.length === 0) {
        el.jobListContainer.innerHTML = `<div class="text-center text-[var(--text-secondary)] py-8 card rounded-lg">No build history. Start a new deployment!</div>`;
        updateFavicon(); return;
    }
    el.jobListContainer.innerHTML = trackedJobs.map(job => {
        let sClass = 'status-queued', sIcon = 'fa-solid fa-clock', sText = 'Queued', extra = '', actions = '';
        if(job.status !== 'queued') sText = job.status.replace('_', ' ');

        if (job.status === 'in_progress' || job.status === 'queued') {
            if (job.id) actions += `<button data-run-id="${job.id}" class="cancel-btn px-2 py-1 text-xs rounded bg-yellow-600 text-white" title="Cancel"><i class="fas fa-stop"></i></button>`;
        }
        if (job.status === 'completed') {
            actions += `<button data-run-id="${job.id}" class="rerun-btn px-2 py-1 text-xs rounded bg-blue-600 text-white" title="Re-run"><i class="fas fa-redo"></i></button>`;
        }

        if (job.status === 'error') { sClass = 'status-error'; sIcon = 'fa-solid fa-triangle-exclamation'; sText = 'Setup Error'; extra = `<div class="text-sm text-orange-400 mt-2">${job.errorMessage}</div>`; } 
        else if (job.status === 'in_progress') { sClass = 'status-in_progress'; sIcon = 'fa-solid fa-gear fa-spin-pulse'; } 
        else if (job.status === 'completed') {
            if (job.conclusion === 'success') { sClass = 'status-completed-success'; sIcon = 'fa-solid fa-check-circle'; sText = 'Success'; extra = `<div class="text-sm text-green-400 mt-2">ƒê√£ ho√†n t·∫•t. <a href="https://remotedesktop.google.com/access" target="_blank" class="underline">K·∫øt n·ªëi ngay</a>.</div>`; } 
            else { sClass = 'status-completed-failure'; sIcon = 'fa-solid fa-xmark-circle'; sText = 'Failure'; extra = `<div class="text-sm text-red-400 mt-2">Th·∫•t b·∫°i. <a href="${job.html_url}" target="_blank" class="underline">Xem logs</a>.</div>`; }
        }

        return `<div class="card p-4 rounded-lg job-item ${job.id ? 'job-item-clickable' : ''}" data-job-temp-id="${job.tempId}">
                    <div class="flex justify-between items-center">
                        <div class="flex items-center gap-3 overflow-hidden">
                            <i class="${sIcon} ${sClass === 'status-in_progress'?'':'text-xl'} text-2xl"></i>
                            <div class="overflow-hidden">
                                <span class="font-bold text-lg truncate">${job.name}</span>
                                <div class="text-xs text-[var(--text-secondary)]">${job.startTime.toLocaleString()}</div>
                            </div>
                        </div>
                        <div class="flex items-center gap-2 flex-shrink-0">
                           <div class="status-badge ${sClass}">${sText}</div>
                           <div class="actions">${actions}</div>
                        </div>
                    </div>
                    ${extra}
                </div>`;
    }).join('');
    updateFavicon();
    saveState();
}

async function pollJobStatuses() {
    if (trackedJobs.length === 0 || trackedJobs.every(j => j.status === 'completed' || j.status === 'error')) {
        clearInterval(pollingInterval); pollingInterval = null; updateFavicon(); return;
    }
    const token = el.tokenInput.value;
    if (!token || !ownerLogin) return;
    try {
        const { workflow_runs } = await githubApi(`/repos/${ownerLogin}/${REPO_NAME}/actions/workflows/${WORKFLOW_NAME}/runs`, token);
        let changed = false;
        trackedJobs.forEach(job => {
            if (job.status === 'completed' || job.status === 'error') return;
            const matchingRun = workflow_runs.find(run => new Date(run.created_at) >= new Date(job.startTime.getTime() - 20000) && !trackedJobs.some(j => j.id === run.id && j.tempId !== job.tempId));
            
            if (matchingRun && (job.status !== matchingRun.status || job.conclusion !== matchingRun.conclusion)) {
                changed = true;
                job.id = matchingRun.id; job.status = matchingRun.status; job.conclusion = matchingRun.conclusion; job.html_url = matchingRun.html_url; job.name = `#${matchingRun.run_number} - Build Triggered`;
                
                if (job.status === 'completed') {
                    showDesktopNotification(`Job #${matchingRun.run_number} ${job.conclusion}`, `Your deployment has finished with status: ${job.conclusion}.`);
                }
            }
        });
        if(changed) renderJobs();
    } catch (error) { 
        showToast(`Polling error: ${error.message}`, 'error');
        clearInterval(pollingInterval); pollingInterval = null;
    }
}

function startPolling() {
    if (!pollingInterval && !document.hidden) {
        pollJobStatuses();
        pollingInterval = setInterval(pollJobStatuses, POLLING_INTERVAL_MS);
    }
}

function showDesktopNotification(title, body) {
    if (Notification.permission === 'granted') new Notification(title, { body });
}

// --- Event Listeners ---
el.runBtn.addEventListener("click", async () => {
    const token = el.tokenInput.value;
    const cmd = el.deployCmdInput.value;
    const pin = el.accessPinInput.value.trim();

    if (!token) { showToast("Vui l√≤ng nh·∫≠p GitHub Token.", "error"); return; }
    if (!cmd) { showToast("Vui l√≤ng nh·∫≠p Deployment Command.", "error"); return; }
    if (pin && !/^\d{6}$/.test(pin)) { showToast("PIN ph·∫£i l√† 6 ch·ªØ s·ªë.", "error"); return; }
    if (!cmd.includes('remoting_start_host.exe')) { showToast("Deployment Command kh√¥ng h·ª£p l·ªá.", "error"); return; }
    if (trackedJobs.some(j => j.command === cmd)) { showToast("L·ªánh n√†y ƒë√£ ƒë∆∞·ª£c s·ª≠ d·ª•ng. Vui l√≤ng l·∫•y l·ªánh m·ªõi.", "error"); return; }

    el.runBtn.disabled = true;
    el.runBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ƒêang g·ª≠i...';

    const job = {
        tempId: `job-${Date.now()}`, id: null, status: 'queued', conclusion: null, startTime: new Date(),
        html_url: '#', name: 'Initializing...', command: cmd,
    };
    trackedJobs.unshift(job);
    if (trackedJobs.length > MAX_JOBS) trackedJobs.pop();
    renderJobs();
    
    try {
        if (!ownerLogin) {
            const user = await githubApi("/user", token);
            ownerLogin = user.login;
            saveState();
        }
        await githubApi(`/repos/${ownerLogin}/${REPO_NAME}`, token).catch(async (e) => {
            if (e.message.includes("404")) {
                await githubApi("/user/repos", token, { method: "POST", body: JSON.stringify({ name: REPO_NAME, private: true }) });
            } else { throw e; }
        });
        
        const path = `.github/workflows/${WORKFLOW_NAME}`;
        const content = workflowContent(cmd, pin || '123456');
        const base64Content = btoa(unescape(encodeURIComponent(content)));
        const url = `/repos/${ownerLogin}/${REPO_NAME}/contents/${path}`;
        let fileSha = null;
        try { fileSha = (await githubApi(url, token)).sha; } catch (e) { if (!e.message.includes("404")) throw e; }
        const body = { message: `ci: Update build config [skip ci]`, content: base64Content };
        if (fileSha) body.sha = fileSha;
        await githubApi(url, token, { method: "PUT", body: JSON.stringify(body) });
        
        await githubApi(`/repos/${ownerLogin}/${REPO_NAME}/actions/workflows/${WORKFLOW_NAME}/dispatches`, token, { method: "POST", body: JSON.stringify({ ref: "main" }) });
        
        el.deployCmdInput.value = '';
        showToast("Build ƒë√£ ƒë∆∞·ª£c k√≠ch ho·∫°t th√†nh c√¥ng!", "success");
        startPolling();
    } catch (e) {
        job.status = 'error';
        job.errorMessage = e.message;
        renderJobs();
        showToast(`L·ªói thi·∫øt l·∫≠p: ${e.message}`, 'error');
    } finally {
        el.runBtn.disabled = false;
        el.runBtn.innerHTML = '<i class="fas fa-play mr-2"></i> Deploy Build';
    }
});

el.refreshBtn.addEventListener('click', async () => {
    const icon = el.refreshBtn.querySelector('i');
    icon.classList.add('fa-spin');
    await pollJobStatuses();
    setTimeout(() => icon.classList.remove('fa-spin'), 500);
});

el.themeToggleBtn.addEventListener('click', () => {
    const newTheme = document.documentElement.dataset.theme === 'dark' ? 'light' : 'dark';
    document.documentElement.dataset.theme = newTheme;
    localStorage.setItem('theme', newTheme);
    el.themeToggleBtn.innerHTML = newTheme === 'dark' ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';
});

el.jobListContainer.addEventListener('click', async e => {
    const jobItem = e.target.closest('.job-item-clickable');
    const cancelBtn = e.target.closest('.cancel-btn');
    const rerunBtn = e.target.closest('.rerun-btn');
    const token = el.tokenInput.value;

    if (cancelBtn) {
        e.stopPropagation();
        const runId = cancelBtn.dataset.runId;
        if (confirm('Are you sure you want to cancel this job?')) {
            try { await cancelWorkflow(token, ownerLogin, runId); showToast('Job cancellation requested.', 'info'); }
            catch (err) { showToast(`Error: ${err.message}`, 'error'); }
        }
    } else if (rerunBtn) {
        e.stopPropagation();
        const runId = rerunBtn.dataset.runId;
        try { await rerunWorkflow(token, ownerLogin, runId); showToast('Job re-run requested.', 'info'); startPolling(); }
        catch (err) { showToast(`Error: ${err.message}`, 'error'); }
    } else if (jobItem) {
        const job = trackedJobs.find(j => j.tempId === jobItem.dataset.jobTempId);
        if (job && job.id) showJobDetails(job);
    }
});

el.addProfileBtn.addEventListener('click', () => addProfile(false));
el.deleteProfileBtn.addEventListener('click', deleteProfile);
el.profileSelect.addEventListener('change', (e) => switchProfile(e.target.value));

[el.tokenInput, el.accessPinInput].forEach(input => input.addEventListener('change', () => {
    const active = profiles.find(p => p.id === activeProfileId);
    if (active) {
        if (input.id === 'token') active.token = input.value;
        if (input.id === 'accessPin') active.pin = input.value;
        saveState();
    }
}));

el.modalCloseBtn.addEventListener('click', closeModal);
el.modalOverlay.addEventListener('click', closeModal);

document.addEventListener('visibilitychange', () => {
    if (document.hidden) { clearInterval(pollingInterval); pollingInterval = null; } 
    else { startPolling(); }
});

document.addEventListener('DOMContentLoaded', () => {
    const savedTheme = localStorage.getItem('theme') || 'dark';
    document.documentElement.dataset.theme = savedTheme;
    el.themeToggleBtn.innerHTML = savedTheme === 'dark' ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';
    if (Notification.permission !== 'granted' && Notification.permission !== 'denied') {
        Notification.requestPermission();
    }
    loadState();
});
</script>
</body>
</html>
