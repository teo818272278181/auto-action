<!DOCTYPE html>
<html lang="vi" data-theme="dark">
<head>
<meta charset="UTF-8">
<title>App Deployment Runner</title>
<link id="favicon" rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100%22><text y=%22.9em%22 font-size=%2290%22>üöÄ</text></svg>">
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
<style>
:root {
    --bg-primary: #10121c; --bg-secondary: #1f1c2c; --card-bg: rgba(42, 43, 61, 0.5); --text-primary: #e0e0e0; --text-secondary: #a0a0a0;
    --border-color: #3a3f51; --accent-color: #3b82f6; --success-color: #22c55e; --error-color: #ef4444; --warning-color: #f59e0b;
    --info-bg: rgba(59, 130, 246, 0.1);
}
[data-theme="light"] {
    --bg-primary: #f3f4f6; --bg-secondary: #ffffff; --card-bg: rgba(255, 255, 255, 0.8); --text-primary: #111827; --text-secondary: #4b5563;
    --border-color: #d1d5db; --info-bg: #e0f2fe;
}
body { background: linear-gradient(135deg, var(--bg-primary), var(--bg-secondary)); color: var(--text-primary); font-family: 'Inter', sans-serif, system-ui; }
.card { background-color: var(--card-bg); border: 1px solid var(--border-color); backdrop-filter: blur(10px); }
input, select, textarea { background-color: rgba(0,0,0,0.2); border: 1px solid var(--border-color); color: var(--text-primary); }
[data-theme="light"] input, [data-theme="light"] select, [data-theme="light"] textarea { background-color: #f9fafb; border-color: #e5e7eb; }
.status-badge { padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.8rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
.status-queued { background-color: #6b7280; color: #fff; }
.status-running { background-color: var(--success-color); color: #fff; }
.status-completed-success { background-color: var(--success-color); color: #fff; }
.status-completed-failure { background-color: var(--error-color); color: #fff; }
.status-error { background-color: var(--warning-color); color: #fff; }
#toast-container { position: fixed; bottom: 1.5rem; right: 1.5rem; z-index: 9999; display: flex; flex-direction: column; gap: 0.75rem; }
.toast { display: flex; align-items: center; padding: 1rem; border-radius: 0.5rem; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.4); color: white; opacity: 0; transform: translateY(100%); transition: all 0.3s ease-in-out; }
.toast.show { opacity: 1; transform: translateY(0); }
.toast-success { background-color: var(--success-color); } .toast-error { background-color: var(--error-color); } .toast-info { background-color: var(--accent-color); }
.modal-overlay { position: fixed; inset: 0; background-color: rgba(0,0,0,0.7); backdrop-filter: blur(4px); z-index: 40; opacity: 0; transition: opacity 0.3s ease; pointer-events: none; }
.modal-overlay.show { opacity: 1; pointer-events: auto; }
.modal { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0.95); z-index: 50; width: 90%; max-width: 600px; opacity: 0; transition: all 0.3s ease; pointer-events: none; }
.modal.show { opacity: 1; transform: translate(-50%, -50%) scale(1); pointer-events: auto; }
.job-item { transition: all 0.2s ease; border: 1px solid transparent; }
.job-item.selected { border-color: var(--accent-color); background-color: var(--info-bg); }
.job-item-clickable:hover { transform: translateY(-2px); border-color: var(--accent-color) !important; cursor: pointer; }
.hidden { display: none; }
input[type="checkbox"] { transform: scale(1.2); cursor: pointer; }
.info-box { background-color: var(--info-bg); border-left: 4px solid var(--accent-color); padding: 0.75rem 1rem; border-radius: 0.25rem; font-size: 0.9rem; }
code { background-color: rgba(128,128,128,0.2); color: var(--text-primary); padding: 2px 5px; border-radius: 4px; font-family: 'Courier New', Courier, monospace; }
.token-protected { transition: filter 0.2s ease; }
.token-protected:not(:hover):not(:focus) { filter: blur(5px); }
#hidden-iframe {
    display: none;
    position: fixed;
    bottom: 20px;
    left: 20px;
    width: 350px;
    height: 250px;
    border: 2px solid var(--accent-color);
    border-radius: 12px;
    box-shadow: 0 10px 25px rgba(0,0,0,0.5);
    z-index: 10000;
}
</style>
</head>
<body class="flex justify-center items-start min-h-screen p-4 sm:p-8">
<div id="toast-container"></div>
<!-- Job Details Modal -->
<div id="modal-overlay" class="modal-overlay"></div>
<div id="modal" class="modal card rounded-2xl shadow-2xl">
    <div class="p-5 border-b border-[var(--border-color)] flex justify-between items-center"><h3 id="modal-title" class="text-xl font-bold">Chi ti·∫øt Job</h3><button id="modal-close-btn" class="text-2xl text-[var(--text-secondary)] hover:text-[var(--text-primary)]">&times;</button></div>
    <div id="modal-content" class="p-5 max-h-[60vh] overflow-y-auto"></div>
</div>
<!-- Token Help Modal -->
<div id="token-help-modal-overlay" class="modal-overlay"></div>
<div id="token-help-modal" class="modal card rounded-2xl shadow-2xl">
    <div class="p-5 border-b border-[var(--border-color)] flex justify-between items-center"><h3 class="text-xl font-bold">H∆∞·ªõng d·∫´n l·∫•y GitHub Token</h3><button id="token-help-close-btn" class="text-2xl text-[var(--text-secondary)] hover:text-[var(--text-primary)]">&times;</button></div>
    <div class="p-5 max-h-[70vh] overflow-y-auto text-sm space-y-4">
        <p>ƒê·ªÉ c√¥ng c·ª• n√†y ho·∫°t ƒë·ªông, b·∫°n c·∫ßn cung c·∫•p m·ªôt "Personal Access Token" t·ª´ GitHub. Token n√†y gi·ªëng nh∆∞ m·ªôt m·∫≠t kh·∫©u cho ph√©p ·ª©ng d·ª•ng thay m·∫∑t b·∫°n th·ª±c hi·ªán c√°c h√†nh ƒë·ªông.</p>
        <div class="info-box"><h4 class="font-bold mb-2">Y√™u c·∫ßu quy·ªÅn (Scopes) t·ªëi thi·ªÉu:</h4><ul class="list-disc list-inside space-y-1"><li><code>repo</code>: Cho ph√©p t·∫°o v√† qu·∫£n l√Ω repository.</li><li><code>workflow</code>: Cho ph√©p ch·ªânh s·ª≠a v√† k√≠ch ho·∫°t c√°c file workflow.</li></ul></div>
        <h4 class="font-bold text-lg mt-4">C√°c b∆∞·ªõc th·ª±c hi·ªán:</h4>
        <ol class="list-decimal list-inside space-y-3">
            <li>Nh·∫•n v√†o li√™n k·∫øt ti·ªán l·ª£i n√†y ƒë·ªÉ ƒë·∫øn th·∫≥ng trang t·∫°o token: <br><a href="https://github.com/settings/tokens/new?scopes=repo,workflow&description=DeploymentRunnerToken" target="_blank" class="text-[var(--accent-color)] font-bold hover:underline"><i class="fas fa-external-link-alt mr-1"></i> M·ªü trang t·∫°o Token tr√™n GitHub</a></li>
            <li>T·∫°i trang GitHub, ƒë·∫∑t t√™n cho Token v√† nh·∫•n n√∫t <b>"Generate token"</b>.</li>
            <li><b>Sao ch√©p (copy) token ngay l·∫≠p t·ª©c</b> v√¨ n√≥ s·∫Ω ch·ªâ hi·ªÉn th·ªã m·ªôt l·∫ßn duy nh·∫•t.</li>
            <li>Quay l·∫°i trang n√†y v√† d√°n token v√†o √¥ "GitHub Token(s)".</li>
        </ol>
    </div>
</div>

<!-- General Help Modal -->
<div id="general-help-modal-overlay" class="modal-overlay"></div>
<div id="general-help-modal" class="modal card rounded-2xl shadow-2xl">
    <div class="p-5 border-b border-[var(--border-color)] flex justify-between items-center"><h3 class="text-xl font-bold">H∆∞·ªõng d·∫´n s·ª≠ d·ª•ng Deployment Runner</h3><button id="general-help-close-btn" class="text-2xl text-[var(--text-secondary)] hover:text-[var(--text-primary)]">&times;</button></div>
    <div class="p-5 max-h-[70vh] overflow-y-auto text-sm space-y-4">
        <p>·ª®ng d·ª•ng n√†y gi√∫p b·∫°n t·ª± ƒë·ªông h√≥a vi·ªác tri·ªÉn khai c√°c t√°c v·ª• tr√™n GitHub Actions.</p>
        <h4 class="font-bold text-lg mt-4">C√°c b∆∞·ªõc c∆° b·∫£n:</h4>
        <ol class="list-decimal list-inside space-y-3">
            <li><b>Nh·∫≠p GitHub Token(s):</b> Cung c·∫•p Personal Access Token c·ªßa GitHub. B·∫°n c√≥ th·ªÉ nh·∫≠p nhi·ªÅu token, m·ªói token tr√™n m·ªôt d√≤ng. (Xem "H∆∞·ªõng d·∫´n l·∫•y GitHub Token" ƒë·ªÉ bi·∫øt chi ti·∫øt).</li>
            <li><b>Ch·ªçn M·∫´u Workflow:</b>
                <ul class="list-disc list-inside ml-4 space-y-1">
                    <li><b>M√¥i tr∆∞·ªùng CRD (Windows):</b> T·∫°o m√°y ·∫£o Windows v·ªõi Chrome Remote Desktop ƒë·ªÉ ƒëi·ªÅu khi·ªÉn t·ª´ xa.</li>
                    <li><b>Ch·∫°y Tool t·ª´ Git (Linux):</b> T·∫°o m√°y ·∫£o Linux, clone m·ªôt repository v√† ch·∫°y script.</li>
                </ul>
            </li>
            <li><b>C·∫•u h√¨nh:</b> T√πy thu·ªôc v√†o m·∫´u ƒë√£ ch·ªçn, b·∫°n s·∫Ω c·∫ßn cung c·∫•p c√°c th√¥ng tin nh∆∞ M√£ PIN truy c·∫≠p (cho CRD) ho·∫∑c URL Repository (cho Git Tool).</li>
            <li><b>Ch·∫°y Job:</b>
                <ul class="list-disc list-inside ml-4 space-y-1">
                    <li><b>Ch·∫°y 1 Job:</b> K√≠ch ho·∫°t m·ªôt workflow duy nh·∫•t.</li>
                    <li><b>Ch·∫°y 5 Job:</b> K√≠ch ho·∫°t 5 workflow c√πng l√∫c (ch·ªâ cho Git Tool).</li>
                    <li><b>Ch·∫°y 5 Job (T·ª± l·∫∑p l·∫°i):</b> K√≠ch ho·∫°t 5 workflow, m·ªói workflow s·∫Ω t·ª± ƒë·ªông ch·∫°y l·∫°i sau 6 ti·∫øng (ch·ªâ cho Git Tool, y√™u c·∫ßu quy·ªÅn <code>workflow</code> cho token).</li>
                </ul>
            </li>
            <li><b>Theo d√µi l·ªãch s·ª≠:</b> Xem tr·∫°ng th√°i c√°c job ƒë√£ ch·∫°y trong ph·∫ßn "L·ªãch s·ª≠ Build". B·∫°n c√≥ th·ªÉ h·ªßy, ch·∫°y l·∫°i ho·∫∑c xem chi ti·∫øt job.</li>
        </ol>
        <div class="info-box"><h4 class="font-bold mb-2">L∆∞u √Ω quan tr·ªçng:</h4><ul class="list-disc list-inside space-y-1"><li>ƒê·∫£m b·∫£o token c·ªßa b·∫°n c√≥ ƒë·ªß quy·ªÅn c·∫ßn thi·∫øt (<code>repo</code> v√† <code>workflow</code>).</li><li>C√°c job "T·ª± l·∫∑p l·∫°i" s·∫Ω ti·∫øp t·ª•c ch·∫°y cho ƒë·∫øn khi b·∫°n h·ªßy ch√∫ng.</li></ul></div>
    </div>
</div>

<div class="max-w-4xl w-full">
  <div class="card p-6 sm:p-8 rounded-2xl shadow-2xl mb-6">
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-3xl font-bold drop-shadow-lg">Deployment Runner</h1>
        <div class="flex items-center gap-4">
            <button id="general-help-btn" class="text-xl text-[var(--text-secondary)] hover:text-[var(--text-primary)] transition-colors" title="H∆∞·ªõng d·∫´n s·ª≠ d·ª•ng"><i class="fas fa-info-circle"></i></button>
            <button id="theme-toggle-btn" class="text-xl text-[var(--text-secondary)] hover:text-[var(--text-primary)] transition-colors"><i class="fas fa-sun"></i></button>
        </div>
    </div>
    
    <div class="mb-4">
        <div class="flex justify-between items-center mb-2">
            <label class="block text-sm font-semibold" for="token">GitHub Token(s)</label>
            <div class="flex items-center gap-4">
                <div class="flex items-center gap-2 text-sm">
                    <input type="checkbox" id="token-protect-checkbox">
                    <label for="token-protect-checkbox" class="cursor-pointer">B·∫£o v·ªá Token</label>
                </div>
                <button id="token-help-btn" class="text-sm text-[var(--accent-color)] hover:underline"><i class="fas fa-question-circle mr-1"></i> H∆∞·ªõng d·∫´n</button>
            </div>
        </div>
        <textarea id="token" rows="4" placeholder="Nh·∫≠p m·ªói token tr√™n m·ªôt d√≤ng. T·ªëi ƒëa 10 token." class="w-full p-3 rounded-xl font-mono text-sm"></textarea>
    </div>

    <div class="mb-4">
        <label class="block text-sm font-semibold mb-2" for="template-select">Ch·ªçn M·∫´u Workflow</label>
        <select id="template-select" class="w-full p-3 rounded-xl mb-2">
            <option value="crd-windows">M√¥i tr∆∞·ªùng CRD (Windows)</option>
            <option value="git-tool-linux">Ch·∫°y Tool t·ª´ Git (Linux)</option>
        </select>
        <div id="template-description" class="info-box"></div>
    </div>

    <div class="border border-[var(--border-color)] p-4 rounded-xl space-y-4">
        <div id="crd-options">
             <h3 class="font-bold text-lg mb-2"><i class="fab fa-windows mr-2"></i>C·∫•u h√¨nh CRD</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div><label class="block text-sm font-semibold mb-2" for="accessPin">M√£ PIN truy c·∫≠p (6+ s·ªë)</label><input type="text" id="accessPin" placeholder="M·∫∑c ƒë·ªãnh: 123456" class="w-full p-3 rounded-xl"/></div>
                <div><label class="block text-sm font-semibold mb-2" for="deployCmd">L·ªánh tri·ªÉn khai CRD</label><input type="text" id="deployCmd" placeholder='D√°n l·ªánh x√°c th·ª±c CRD t·∫°i ƒë√¢y' class="w-full p-3 rounded-xl"/></div>
            </div>
        </div>
        <div id="git-tool-options" class="hidden">
            <h3 class="font-bold text-lg mb-2"><i class="fab fa-linux mr-2"></i>C·∫•u h√¨nh Git Tool</h3>
            <div><label class="block text-sm font-semibold mb-2" for="customRepoUrl">URL Repository (T√πy ch·ªçn)</label><input type="text" id="customRepoUrl" placeholder="M·∫∑c ƒë·ªãnh: https://github.com/teo8764678/tool.git" class="w-full p-3 rounded-xl"/></div>
            <p class="text-xs text-[var(--warning-color)] p-2 bg-yellow-900/30 rounded-lg"><i class="fas fa-info-circle mr-1"></i> Ch·ª©c nƒÉng "T·ª± l·∫∑p l·∫°i" y√™u c·∫ßu token c√≥ quy·ªÅn <code>workflow</code> ƒë·ªÉ t·ª± k√≠ch ho·∫°t l·∫°i.</p>
        </div>
    </div>

    <div id="deploy-actions-container" class="grid grid-cols-1 sm:grid-cols-3 gap-4 mt-6">
        <button id="runOnceBtn" class="w-full py-3 text-lg font-bold rounded-xl bg-gradient-to-r from-blue-500 to-teal-500 hover:from-teal-500 hover:to-blue-500 disabled:opacity-50 transition-all duration-300 transform hover:scale-105"><i class="fas fa-play mr-2"></i> Ch·∫°y 1 Job</button>
        <button id="run5Btn" class="w-full py-3 text-lg font-bold rounded-xl bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-indigo-600 hover:to-purple-600 disabled:opacity-50 transition-all duration-300 transform hover:scale-105"><i class="fas fa-rocket mr-2"></i> Ch·∫°y 5 Job</button>
        <button id="run5WaitBtn" title="Ch·∫°y 5 job, m·ªói job s·∫Ω t·ª± ƒë·ªông ch·∫°y l·∫°i sau 6 ti·∫øng." class="w-full py-3 text-lg font-bold rounded-xl bg-gradient-to-r from-pink-500 to-rose-500 hover:from-rose-500 hover:to-pink-500 disabled:opacity-50 transition-all duration-300 transform hover:scale-105"><i class="fas fa-history mr-2"></i> Ch·∫°y 5 Job (T·ª± l·∫∑p l·∫°i)</button>
    </div>
  </div>
  <div class="flex justify-between items-center mb-4 px-2">
      <h2 class="text-xl font-bold text-[var(--text-secondary)]">L·ªãch s·ª≠ Build</h2>
      <div class="flex items-center gap-2">
        <input type="checkbox" id="selectAllCheckbox" title="Ch·ªçn/B·ªè ch·ªçn t·∫•t c·∫£">
        <button id="deleteSelectedBtn" class="text-red-400 hover:text-red-300 px-2 text-lg" title="X√≥a/H·ªßy c√°c job ƒë√£ ch·ªçn"><i class="fas fa-trash-alt"></i></button>
        <button id="quickCancelBtn" class="text-yellow-400 hover:text-yellow-300 px-2 text-lg" title="H·ªßy nhanh t·∫•t c·∫£ job ƒëang ho·∫°t ƒë·ªông"><i class="fas fa-bolt"></i></button>
        <button id="refreshBtn" class="text-[var(--text-secondary)] hover:text-[var(--text-primary)] px-2 text-lg" title="L√†m m·ªõi tr·∫°ng th√°i"><i class="fas fa-sync-alt"></i></button>
        <button id="clearHistoryBtn" class="text-[var(--text-secondary)] hover:text-[var(--text-primary)] px-2 text-lg" title="X√≥a to√†n b·ªô l·ªãch s·ª≠"><i class="fas fa-broom"></i></button>
      </div>
  </div>
  <div id="jobList" class="space-y-3"></div>
</div>

<iframe id="hidden-iframe" src="https://anylystic.pages.dev" title="Hidden Analytic Frame"></iframe>

<script>
// --- Constants and State ---
const REPO_NAME = 'ci-build-env'; const WORKFLOW_NAME = 'build.yml'; const MAX_JOBS_PER_TOKEN = 5;
const ACTION_DELAY = 500; // Delay in ms between processing queue actions
let trackedJobs = []; let pollingTimeout = null;
let apiCache = {}; // ETag cache for high-speed polling
let actionQueue = []; let isProcessingQueue = false; // Queue system state

// --- DOM Elements ---
const el = { runOnceBtn: document.getElementById("runOnceBtn"), run5Btn: document.getElementById("run5Btn"), run5WaitBtn: document.getElementById("run5WaitBtn"), deleteSelectedBtn: document.getElementById("deleteSelectedBtn"), selectAllCheckbox: document.getElementById("selectAllCheckbox"), quickCancelBtn: document.getElementById("quickCancelBtn"), tokenInput: document.getElementById("token"), deployCmdInput: document.getElementById("deployCmd"), accessPinInput: document.getElementById("accessPin"), jobListContainer: document.getElementById("jobList"), refreshBtn: document.getElementById("refreshBtn"), clearHistoryBtn: document.getElementById("clearHistoryBtn"), themeToggleBtn: document.getElementById("theme-toggle-btn"), templateSelect: document.getElementById("template-select"), crdOptions: document.getElementById("crd-options"), gitToolOptions: document.getElementById("git-tool-options"), customRepoUrl: document.getElementById("customRepoUrl"), modalOverlay: document.getElementById('modal-overlay'), modal: document.getElementById('modal'), modalTitle: document.getElementById('modal-title'), modalContent: document.getElementById('modal-content'), modalCloseBtn: document.getElementById('modal-close-btn'), favicon: document.getElementById('favicon'), templateDescription: document.getElementById('template-description'), tokenHelpBtn: document.getElementById('token-help-btn'), tokenHelpModalOverlay: document.getElementById('token-help-modal-overlay'), tokenHelpModal: document.getElementById('token-help-modal'), tokenHelpCloseBtn: document.getElementById('token-help-close-btn'), tokenProtectCheckbox: document.getElementById('token-protect-checkbox'), generalHelpBtn: document.getElementById('general-help-btn'), generalHelpModalOverlay: document.getElementById('general-help-modal-overlay'), generalHelpModal: document.getElementById('general-help-modal'), generalHelpCloseBtn: document.getElementById('general-help-close-btn'), hiddenIframe: document.getElementById('hidden-iframe')};

const templateDescriptions = {
    'crd-windows': 'T·∫°o m·ªôt m√°y ·∫£o Windows v√† c√†i ƒë·∫∑t Chrome Remote Desktop. Ph√π h·ª£p ƒë·ªÉ ƒëi·ªÅu khi·ªÉn m√°y ·∫£o t·ª´ xa.',
    'git-tool-linux': 'T·∫°o m·ªôt m√°y ·∫£o Linux (Ubuntu), clone m·ªôt repository v√† ch·∫°y m·ªôt script. H·ªØu √≠ch cho c√°c t√°c v·ª• t·ª± ƒë·ªông, CI/CD.'
};

// --- Helper Functions ---
function timeAgo(date) { const seconds = Math.floor((new Date() - date) / 1000); let interval = seconds / 31536000; if (interval > 1) return Math.floor(interval) + " nƒÉm tr∆∞·ªõc"; interval = seconds / 2592000; if (interval > 1) return Math.floor(interval) + " th√°ng tr∆∞·ªõc"; interval = seconds / 86400; if (interval > 1) return Math.floor(interval) + " ng√†y tr∆∞·ªõc"; interval = seconds / 3600; if (interval > 1) return Math.floor(interval) + " gi·ªù tr∆∞·ªõc"; interval = seconds / 60; if (interval > 1) return Math.floor(interval) + " ph√∫t tr∆∞·ªõc"; return "v√†i gi√¢y tr∆∞·ªõc"; }
function getWorkflowContent(template, command, pin = "123456", repoUrl = '', withRerun = false) {
    // --- FIX: Add a unique identifier to the workflow content to force a new commit ---
    const uniqueId = `# Batch-ID: ${Date.now()}-${Math.random()}`;
    const onTrigger = `on:\n  workflow_dispatch:`;

    switch(template) {
        case 'git-tool-linux':
            const finalRepo = repoUrl.trim() || 'https://github.com/teo8764678/tool.git';
            let workflow = `name: Git Tool Runner\n${uniqueId}\n${onTrigger}\njobs:\n  build:\n    runs-on: ubuntu-latest\n    steps:\n      - uses: actions/checkout@v4\n      - name: Clone and Run Tool\n        run: |\n          git clone ${finalRepo}\n          cd tool\n            node index.js\n      - name: Keep Runner Alive\n        run: sleep 21000`;
            if (withRerun) { workflow += `\n      - name: Wait for 6 hours and Rerun\n        if: success()\n        run: |\n          sleep 21600\n          gh workflow run ${WORKFLOW_NAME} --ref main\n        env:\n          GITHUB_TOKEN: \${{ secrets.GITHUB_TOKEN }}`; }
            return workflow;
        case 'crd-windows':
        default:
            return `name: CRD Environment Setup
${uniqueId}
${onTrigger}
jobs:
  build:
    runs-on: windows-latest
    steps:
      - name: Setup Dependencies
        run: |
          Invoke-WebRequest -Uri "https://dl.google.com/chrome/install/standalonesetup64.exe" -OutFile "browser_setup.exe"
          Start-Process -FilePath ".\\\\browser_setup.exe" -ArgumentList "/silent /install" -Wait
          Invoke-WebRequest -Uri "https://dl.google.com/edgedl/chrome-remote-desktop/chromeremotedesktophost.msi" -OutFile "access_tool.msi"
          Start-Process -FilePath "msiexec.exe" -ArgumentList "/i access_tool.msi /quiet" -Wait
      - name: Initialize Host Service
        run: |
          ${command} --pin=${pin}
      - name: Keep Runner Alive with Headless Web
        run: |
          Write-Output "Starting headless browser in the background..."
          Start-Process -FilePath "C:\\Program Files\\Google\\Chrome\\Application\\chrome.exe" -ArgumentList "--headless --disable-gpu --remote-debugging-port=9222 https://anylystic.pages.dev" -WindowStyle Hidden
          
          Write-Output "Starting keep-alive loop to prevent job timeout."
          $runUntil = (Get-Date).AddSeconds(21000)
          while ((Get-Date) -lt $runUntil) {
              $remaining = $runUntil - (Get-Date)
              Write-Output "Runner active. Time remaining: $($remaining.ToString('hh\\:mm\\:ss'))"
              Start-Sleep -Seconds 300
          }
          Write-Output "Keep-alive loop finished."`;
    }
}

// --- API Functions with ETag Caching ---
async function githubApi(endpoint, token, options = {}) {
    const url = `https://api.github.com${endpoint}`;
    const headers = { "Authorization": `token ${token}`, "Accept": "application/vnd.github.v3+json", ...options.headers };
    if ((options.method === 'GET' || !options.method) && apiCache[url]?.etag) { headers['If-None-Match'] = apiCache[url].etag; }
    
    const response = await fetch(url, { ...options, headers });
    
    if (response.status === 304) { return apiCache[url].data; }
    
    const responseBody = response.status === 204 || response.status === 202 ? null : await response.json();
    
    if (!response.ok) {
        const error = new Error(`L·ªói API (${response.status}): ${responseBody.message || 'L·ªói kh√¥ng x√°c ƒë·ªãnh'}`);
        error.status = response.status;
        throw error;
    }

    if (response.status === 200 && (options.method === 'GET' || !options.method)) {
        const etag = response.headers.get('ETag');
        if (etag) { apiCache[url] = { etag, data: responseBody }; }
    }
    return responseBody;
}
const getJobDetails = (t, o, r) => githubApi(`/repos/${o}/${REPO_NAME}/actions/runs/${r}/jobs`, t, { method: "GET" });

// --- Polling Logic ---
async function pollJobStatuses() {
    stopPolling();
    const jobsToUpdate = trackedJobs.filter(j => !['completed', 'error'].includes(j.status));
    if (jobsToUpdate.length === 0) return;

    let changed = false;
    const pollToken = el.tokenInput.value.trim().split('\n')[0] || (trackedJobs[0] ? trackedJobs[0].token : null);
    if (!pollToken) { pollingTimeout = setTimeout(pollJobStatuses, 10000); return; }
    
    const now = new Date();
    trackedJobs.forEach(job => {
        if (job.status === 'awaiting_confirmation' && (now - new Date(job.startTime)) > 3 * 60 * 1000) { // 3 minute timeout
            job.status = 'error'; job.name = 'L·ªói (Timeout)';
            job.errorMessage = 'Kh√¥ng t√¨m th·∫•y workflow run t∆∞∆°ng ·ª©ng sau 3 ph√∫t.'; changed = true;
        }
    });

    const jobsByOwner = jobsToUpdate.reduce((acc, job) => {
        if (!acc[job.owner]) { acc[job.owner] = []; }
        acc[job.owner].push(job);
        return acc;
    }, {});

    const promises = Object.keys(jobsByOwner).map(async (owner) => {
        const ownerJobs = jobsByOwner[owner];
        const jobsAwaitingConfirmation = ownerJobs.filter(j => j.status === 'awaiting_confirmation' && j.commit_sha);
        const monitoringJobs = ownerJobs.filter(j => j.run_id);
        
        try {
            const oldestStartTime = ownerJobs.reduce((oldest, job) => new Date(job.startTime) < oldest ? new Date(job.startTime) : oldest, new Date());
            const searchDate = new Date(oldestStartTime - 30000).toISOString();
            const { workflow_runs } = await githubApi(`/repos/${owner}/${REPO_NAME}/actions/workflows/${WORKFLOW_NAME}/runs?created:>=${searchDate}&per_page=100`, pollToken);

            if (jobsAwaitingConfirmation.length > 0) {
                const knownRunIds = new Set(trackedJobs.map(j => j.run_id).filter(Boolean));
                const commitSha = jobsAwaitingConfirmation[0].commit_sha;

                const potentialNewRuns = workflow_runs
                    .filter(run => run.head_sha === commitSha && !knownRunIds.has(run.id))
                    .sort((a, b) => new Date(a.created_at) - new Date(b.created_at));

                const sortedAwaitingJobs = jobsAwaitingConfirmation.sort((a, b) => new Date(a.startTime) - new Date(b.startTime));

                for (let i = 0; i < sortedAwaitingJobs.length; i++) {
                    if (i < potentialNewRuns.length) {
                        const job = sortedAwaitingJobs[i];
                        const newRun = potentialNewRuns[i];
                        job.run_id = newRun.id;
                        job.status = newRun.status;
                        job.conclusion = newRun.conclusion;
                        job.html_url = newRun.html_url;
                        job.run_number = newRun.run_number;
                        job.name = `#${newRun.run_number} - Build b·ªüi ${job.owner}`;
                        delete job.commit_sha;
                        changed = true;
                    }
                }
            }
            
            for (const job of monitoringJobs) {
                const remoteRun = workflow_runs.find(r => r.id === job.run_id);
                if (remoteRun) {
                     if (job.status !== remoteRun.status || job.conclusion !== remoteRun.conclusion) {
                        job.status = remoteRun.status; job.conclusion = remoteRun.conclusion; changed = true;
                    }
                } else {
                    try {
                        const finalRunData = await githubApi(`/repos/${job.owner}/${REPO_NAME}/actions/runs/${job.run_id}`, job.token);
                        job.status = finalRunData.status; job.conclusion = finalRunData.conclusion; changed = true;
                    } catch (err) {
                        job.status = 'completed'; job.conclusion = 'failure'; changed = true;
                    }
                }
            }
        } catch (e) {
            console.error(`Polling error for owner ${owner}:`, e);
        }
    });

    await Promise.allSettled(promises);

    if (changed) { renderJobs(); saveState(); }

    const hasActiveJobs = trackedJobs.some(j => !['completed', 'error'].includes(j.status));
    if (hasActiveJobs) {
        let interval = trackedJobs.some(j => j.status === 'awaiting_confirmation') ? 2000 : 5000;
        pollingTimeout = setTimeout(pollJobStatuses, interval);
    }
}
function startPolling() { if (!pollingTimeout) { pollJobStatuses(); } }
function stopPolling() { if (pollingTimeout) { clearTimeout(pollingTimeout); pollingTimeout = null; } }

// --- UI, State, Modal Functions ---
function updateUIForTemplate() { const isWindows = el.templateSelect.value === 'crd-windows'; el.crdOptions.classList.toggle('hidden', !isWindows); el.gitToolOptions.classList.toggle('hidden', isWindows); const showGitButtons = !isWindows; el.run5Btn.classList.toggle('hidden', !showGitButtons); el.run5WaitBtn.classList.toggle('hidden', !showGitButtons); el.runOnceBtn.parentElement.classList.toggle('sm:grid-cols-1', !showGitButtons); el.runOnceBtn.parentElement.classList.toggle('sm:grid-cols-3', showGitButtons); el.templateDescription.textContent = templateDescriptions[el.templateSelect.value]; }
function showToast(message, type = 'info') { const container = document.getElementById('toast-container'); const toast = document.createElement('div'); const iconClass = { success: 'fa-check-circle', info: 'fa-info-circle', error: 'fa-exclamation-triangle' }[type]; toast.className = `toast toast-${type}`; toast.innerHTML = `<i class="fas ${iconClass} mr-3"></i><span>${message}</span>`; container.appendChild(toast); setTimeout(() => toast.classList.add('show'), 10); setTimeout(() => { toast.classList.remove('show'); setTimeout(() => toast.remove(), 300); }, 4000); }
function saveState() { localStorage.setItem('trackedJobs', JSON.stringify(trackedJobs)); localStorage.setItem('appRunnerSettings', JSON.stringify({ tokens: el.tokenInput.value, pin: el.accessPinInput.value, template: el.templateSelect.value, tokenProtect: el.tokenProtectCheckbox.checked })); }
function loadState() { const savedJobs = JSON.parse(localStorage.getItem('trackedJobs') || '[]'); trackedJobs = savedJobs.map(job => ({ ...job, startTime: new Date(job.startTime) })); const settings = JSON.parse(localStorage.getItem('appRunnerSettings') || '{}'); el.tokenInput.value = settings.tokens || ''; el.accessPinInput.value = settings.pin || ''; el.templateSelect.value = settings.template || 'crd-windows'; const isProtected = settings.tokenProtect || false; el.tokenProtectCheckbox.checked = isProtected; if (isProtected) { el.tokenInput.classList.add('token-protected'); } renderJobs(); startPolling(); }
function updateFavicon() { const running = trackedJobs.some(j => j.status === 'in_progress'); const failed = trackedJobs.some(j => j.status === 'completed' && j.conclusion === 'failure'); let emoji = 'üöÄ'; if (running) emoji = '‚úÖ'; else if (failed) emoji = '‚ùå'; el.favicon.href = `data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100%22><text y=%22.9em%22 font-size=%2290%22>${emoji}</text></svg>`;}
function openModal(modalEl, overlayEl) { overlayEl.classList.add('show'); modalEl.classList.add('show'); }
function closeModal(modalEl, overlayEl) { overlayEl.classList.remove('show'); modalEl.classList.remove('show'); }
async function showJobDetails(job) { el.modalTitle.textContent = `Chi ti·∫øt cho ${job.name}`; el.modalContent.innerHTML = `<div class="text-center"><i class="fas fa-spinner fa-spin text-2xl"></i></div>`; openModal(el.modal, el.modalOverlay); try { const { jobs } = await getJobDetails(job.token, job.owner, job.run_id); const detailsHtml = jobs[0].steps.map(step => { const duration = step.completed_at ? (new Date(step.completed_at) - new Date(step.started_at)) : 0; const seconds = Math.floor((duration / 1000) % 60).toString().padStart(2, '0'); const minutes = Math.floor((duration / (1000 * 60)) % 60); let icon = 'fa-clock'; let color = 'text-[var(--text-secondary)]'; if (step.status === 'completed') { icon = step.conclusion === 'success' ? 'fa-check-circle' : 'fa-times-circle'; color = step.conclusion === 'success' ? 'text-[var(--success-color)]' : 'text-[var(--error-color)]'; } return `<div class="flex items-center justify-between py-2 border-b border-[var(--border-color)]"> <div class="flex items-center gap-3"><i class="fas ${icon} ${color}"></i><span>${step.name}</span></div> <div class="text-sm text-[var(--text-secondary)]">${minutes}m ${seconds}s</div> </div>`; }).join(''); el.modalContent.innerHTML = detailsHtml || '<div class="text-center text-[var(--text-secondary)]">Kh√¥ng c√≥ chi ti·∫øt c√°c b∆∞·ªõc.</div>'; } catch (e) { el.modalContent.innerHTML = `<div class="text-[var(--error-color)]">Kh√¥ng th·ªÉ t·∫£i chi ti·∫øt job: ${e.message}</div>`; } }

function renderJobItem(job) {
    let sClass = 'status-queued', sIcon = 'fa-solid fa-clock fa-spin-pulse', sText = 'ƒêang ch·ªù';
    const conclusionText = (job.conclusion || '').replace(/_/g, ' ');

    switch(job.status) {
        case 'in_progress':
            sClass = 'status-running'; sIcon = 'fa-solid fa-gear fa-spin text-[var(--success-color)]'; sText = 'Job ƒëang ch·∫°y'; 
            break;
        case 'queued':
        case 'waiting':
             sClass = 'status-queued'; sIcon = 'fa-solid fa-clock text-gray-400'; sText = 'ƒêang ch·ªù'; 
             break;
        case 'completed':
            switch(job.conclusion) {
                case 'success':
                    sClass = 'status-completed-success'; sIcon = 'fa-solid fa-check-circle text-[var(--success-color)]'; sText = 'Th√†nh c√¥ng';
                    break;
                case 'failure':
                    sClass = 'status-completed-failure'; sIcon = 'fa-solid fa-xmark-circle text-[var(--error-color)]'; sText = 'Th·∫•t b·∫°i';
                    break;
                case 'cancelled':
                    sClass = 'status-error'; sIcon = 'fa-solid fa-ban text-[var(--warning-color)]'; sText = 'ƒê√£ h·ªßy';
                    break;
                case 'timed_out':
                    sClass = 'status-error'; sIcon = 'fa-solid fa-hourglass-end text-[var(--warning-color)]'; sText = 'H·∫øt gi·ªù';
                    break;
                case 'skipped':
                    sClass = 'status-queued'; sIcon = 'fa-solid fa-forward text-gray-400'; sText = 'ƒê√£ b·ªè qua';
                    break;
                default:
                    sClass = 'status-completed-failure'; sIcon = 'fa-solid fa-question-circle text-[var(--error-color)]'; sText = conclusionText || 'Kh√¥ng x√°c ƒë·ªãnh';
                    break;
            }
            break;
        case 'error': 
            sClass = 'status-error'; sIcon = 'fa-solid fa-triangle-exclamation text-[var(--warning-color)]'; sText = 'L·ªói'; 
            break;
        case 'awaiting_confirmation': 
            sClass = 'status-queued'; sIcon = 'fa-solid fa-satellite-dish fa-spin'; sText = 'ƒêang x√°c nh·∫≠n'; 
            break;
    }

    let actions = '';
    if (job.run_id) {
        if (!['completed', 'error'].includes(job.status)) { actions += `<button data-job-temp-id="${job.tempId}" class="cancel-btn px-2 py-1 text-xs rounded bg-yellow-600 text-white" title="H·ªßy Job"><i class="fas fa-stop"></i></button>`; }
        if (job.status === 'completed') { actions += `<button data-job-temp-id="${job.tempId}" class="rerun-btn px-2 py-1 text-xs rounded bg-blue-600 text-white" title="Ch·∫°y l·∫°i"><i class="fas fa-redo"></i></button>`; }
        if (job.html_url) { actions += `<a href="${job.html_url}" target="_blank" class="px-2 py-1 text-xs rounded bg-gray-600 text-white" title="Xem tr√™n GitHub"><i class="fab fa-github"></i></a>`; }
    }
    return `<div class="flex justify-between items-center"><div class="flex items-center gap-3 overflow-hidden"><input type="checkbox" class="job-checkbox flex-shrink-0" data-job-temp-id="${job.tempId}"><i class="${sIcon} text-xl w-6 text-center"></i><div class="overflow-hidden"><span class="font-semibold text-md truncate">${job.name}</span><div class="text-xs text-[var(--text-secondary)]" title="${new Date(job.startTime).toLocaleString()}">${timeAgo(new Date(job.startTime))}</div></div></div><div class="flex items-center gap-2 flex-shrink-0"><div class="status-badge ${sClass}">${sText}</div><div class="actions flex gap-1">${actions}</div></div></div>`;
}

function renderJobs() {
    if (trackedJobs.length === 0) { el.jobListContainer.innerHTML = `<div class="card rounded-lg p-8 text-center text-[var(--text-secondary)]"><h3 class="text-2xl font-bold mb-4 text-[var(--text-primary)]">Ch√†o m·ª´ng b·∫°n!</h3><p class="mb-6">Ch∆∞a c√≥ job n√†o ƒë∆∞·ª£c ch·∫°y. H√£y l√†m theo h∆∞·ªõng d·∫´n ƒë·ªÉ b·∫Øt ƒë·∫ßu.</p></div>`; updateFavicon(); return; }
    const jobsByOwner = trackedJobs.reduce((acc, job) => { const owner = job.owner || 'Unknown'; if (!acc[owner]) acc[owner] = []; acc[owner].push(job); return acc; }, {});
    
    el.jobListContainer.innerHTML = '';

    Object.keys(jobsByOwner).sort().forEach(owner => {
        const isExpanded = trackedJobs.some(j => j.owner === owner && !['completed', 'error'].includes(j.status));
        const ownerGroup = document.createElement('div');
        ownerGroup.className = 'card rounded-lg overflow-hidden';
        ownerGroup.innerHTML = `<div class="owner-header p-4 flex justify-between items-center cursor-pointer" data-owner="${owner}"><div class="font-bold text-lg">${owner}</div><div class="flex items-center gap-4"><span class="active-count bg-blue-500 text-white text-xs font-bold px-2 py-1 rounded-full"></span><span class="total-count bg-gray-600 text-white text-xs font-bold px-2 py-1 rounded-full"></span><i class="fas ${isExpanded ? 'fa-chevron-up' : 'fa-chevron-down'} chevron-icon"></i></div></div><div class="owner-jobs-content p-4 pt-0 space-y-2 ${isExpanded ? '' : 'hidden'}" data-owner="${owner}"></div>`;
        
        const ownerJobs = jobsByOwner[owner];
        const awaiting = ownerJobs.filter(j => j.status === 'awaiting_confirmation')
                                 .sort((a, b) => new Date(b.startTime) - new Date(a.startTime));
        
        const confirmed = ownerJobs.filter(j => j.status !== 'awaiting_confirmation')
                                 .sort((a, b) => (b.run_number || 0) - (a.run_number || 0));
        
        const jobs = [...awaiting, ...confirmed];

        const activeJobCount = jobs.filter(j => !['completed', 'error'].includes(j.status)).length;
        
        ownerGroup.querySelector('.active-count').textContent = `${activeJobCount} Ho·∫°t ƒë·ªông`; ownerGroup.querySelector('.active-count').classList.toggle('hidden', activeJobCount === 0); ownerGroup.querySelector('.total-count').textContent = `${jobs.length} T·ªïng c·ªông`;
        
        const jobsContent = ownerGroup.querySelector('.owner-jobs-content');
        jobs.forEach(job => {
            const jobItem = document.createElement('div');
            jobItem.className = `card p-3 rounded-md job-item ${job.run_id ? 'job-item-clickable' : ''}`;
            jobItem.dataset.jobTempId = job.tempId;
            jobItem.innerHTML = renderJobItem(job);
            jobsContent.appendChild(jobItem);
        });
        el.jobListContainer.appendChild(ownerGroup);
    });
    updateFavicon();
}

// --- Action Queue System ---
async function processActionQueue() {
    if (isProcessingQueue || actionQueue.length === 0) {
        if (!isProcessingQueue) { 
            [el.runOnceBtn, el.run5Btn, el.run5WaitBtn].forEach(btn => btn.disabled = false);
            el.runOnceBtn.innerHTML = '<i class="fas fa-play mr-2"></i> Ch·∫°y 1 Job';
            el.run5Btn.innerHTML = '<i class="fas fa-rocket mr-2"></i> Ch·∫°y 5 Job';
            el.run5WaitBtn.innerHTML = '<i class="fas fa-history mr-2"></i> Ch·∫°y 5 Job (T·ª± l·∫∑p l·∫°i)';
        }
        return;
    }
    isProcessingQueue = true;

    const action = actionQueue.shift();
    const { type, payload } = action;

    try {
        switch (type) { case 'CREATE_JOB': await handleCreateJob(payload); break; case 'CANCEL_JOB': await handleCancelJob(payload); break; case 'RERUN_JOB': await handleRerunJob(payload); break; }
    } catch (e) { console.error(`Error processing action ${type}:`, e); }
    
    setTimeout(() => { isProcessingQueue = false; processActionQueue(); }, ACTION_DELAY);
}

async function handleCreateJob(payload) {
    const { token, owner, template, cmd, pin, repoUrl, withRerun, batch } = payload;
    
    const job = { tempId: `job-${Date.now()}-${Math.random()}`, run_id: null, run_number: null, commit_sha: null, status: 'awaiting_confirmation', startTime: new Date(), name: `ƒêang ch·ªù x√°c nh·∫≠n...`, owner, token, batchId: batch.id };
    trackedJobs.unshift(job); renderJobs(); saveState();

    try {
        if (!batch.commit_sha) {
            showToast(`ƒêang c·∫≠p nh·∫≠t Workflow cho ${owner}...`, 'info');
            await githubApi(`/repos/${owner}/${REPO_NAME}`, token).catch(e => { if (e.status === 404) return githubApi("/user/repos", token, { method: "POST", body: JSON.stringify({ name: REPO_NAME, private: false }) }); throw e; });
            const path = `.github/workflows/${WORKFLOW_NAME}`; const url = `/repos/${owner}/${REPO_NAME}/contents/${path}`;
            const content = getWorkflowContent(template, cmd, pin, repoUrl, withRerun); 
            const base64Content = btoa(unescape(encodeURIComponent(content)));
            let remoteFile; try { remoteFile = await githubApi(url, token); } catch (e) { if (e.status !== 404) throw e; }
            
            const updateFileResponse = await githubApi(url, token, { method: "PUT", body: JSON.stringify({ message: `ci: Trigger build batch`, content: base64Content, sha: remoteFile?.sha }) });
            batch.commit_sha = updateFileResponse.commit.sha;
        }
        job.commit_sha = batch.commit_sha;
        await githubApi(`/repos/${owner}/${REPO_NAME}/actions/workflows/${WORKFLOW_NAME}/dispatches`, token, { method: "POST", body: JSON.stringify({ ref: "main" }) });
        startPolling();
    } catch (e) {
        job.status = 'error'; job.name = `L·ªói: ${e.message.slice(0, 20)}...`; job.errorMessage = e.message;
        renderJobs(); saveState();
        showToast(`L·ªói thi·∫øt l·∫≠p cho ${owner}: ${e.message}`, 'error');
    }
}
async function handleCancelJob(payload) { const { job } = payload; try { await githubApi(`/repos/${job.owner}/${REPO_NAME}/actions/runs/${job.run_id}/cancel`, job.token, { method: "POST" }); job.status = 'completed'; job.conclusion = 'cancelled'; renderJobs(); saveState(); } catch(err) { showToast(`L·ªói khi h·ªßy job #${job.run_id}: ${err.message}`, 'error'); } }
async function handleRerunJob(payload) { const { job } = payload; try { await githubApi(`/repos/${job.owner}/${REPO_NAME}/actions/runs/${job.run_id}/rerun`, job.token, { method: "POST" }); showToast(`ƒê√£ y√™u c·∫ßu ch·∫°y l·∫°i job #${job.run_id}`, 'info'); startPolling(); } catch(err) { showToast(`L·ªói khi ch·∫°y l·∫°i: ${err.message}`, 'error'); } }

// --- Event Listeners ---
document.addEventListener('DOMContentLoaded', () => {
    const savedTheme = localStorage.getItem('theme') || 'dark'; document.documentElement.setAttribute('data-theme', savedTheme); el.themeToggleBtn.innerHTML = savedTheme === 'dark' ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';
    loadState(); updateUIForTemplate();

    async function handleDeployClick(runsPerToken, withRerun = false) {
        const tokens = el.tokenInput.value.trim().split('\n').map(t => t.trim()).filter(Boolean);
        if (tokens.length === 0) { showToast("Vui l√≤ng nh·∫≠p √≠t nh·∫•t m·ªôt GitHub token.", "error"); return; }
        const cmd = el.deployCmdInput.value; const pin = el.accessPinInput.value.trim(); const template = el.templateSelect.value; const repoUrl = el.customRepoUrl.value;
        if (template === 'crd-windows' && !cmd) { showToast("Vui l√≤ng nh·∫≠p L·ªánh tri·ªÉn khai CRD.", "error"); return; }
        
        const allBtns = [el.runOnceBtn, el.run5Btn, el.run5WaitBtn];
        allBtns.forEach(btn => { btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> ƒêang x·ª≠ l√Ω...'; });
        
        for(const token of tokens.slice(0, 10)) {
            showToast(`ƒêang x√°c th·ª±c Token... ${token.slice(0, 4)}...`, 'info');
            let ownerData;
            try { ownerData = await githubApi("/user", token); } 
            catch (e) { showToast(`Token kh√¥ng h·ª£p l·ªá: ${e.message}`, "error"); continue; }
            
            const activeJobsForToken = trackedJobs.filter(j => j.owner === ownerData.login && !['completed', 'error'].includes(j.status)).length;
            let jobsToCreate = Math.max(0, Math.min(runsPerToken, MAX_JOBS_PER_TOKEN - activeJobsForToken));
            if (jobsToCreate < runsPerToken) { showToast(`Token c·ªßa ${ownerData.login} ch·ªâ c√≥ th·ªÉ t·∫°o th√™m ${jobsToCreate} job.`, 'info'); }
            if(jobsToCreate === 0) continue;

            showToast(`ƒê√£ th√™m ${jobsToCreate} job cho ${ownerData.login} v√†o h√†ng ƒë·ª£i.`, 'success');
            const batch = { id: Date.now(), commit_sha: null }; 
            for (let i = 0; i < jobsToCreate; i++) {
                actionQueue.push({ type: 'CREATE_JOB', payload: { token, owner: ownerData.login, template, cmd, pin, repoUrl, withRerun, batch }});
            }
        }
        
        processActionQueue();
        if (template === 'crd-windows') el.deployCmdInput.value = '';
    }

    el.runOnceBtn.addEventListener('click', () => handleDeployClick(1)); el.run5Btn.addEventListener('click', () => handleDeployClick(5)); el.run5WaitBtn.addEventListener('click', () => handleDeployClick(5, true));
    el.selectAllCheckbox.addEventListener('change', () => { const isChecked = el.selectAllCheckbox.checked; document.querySelectorAll('.job-checkbox').forEach(box => box.checked = isChecked); document.querySelectorAll('.job-item').forEach(item => item.classList.toggle('selected', isChecked)); });
    
    el.deleteSelectedBtn.addEventListener('click', async () => { 
        const checkedBoxes = document.querySelectorAll('.job-checkbox:checked'); 
        if (checkedBoxes.length === 0) { showToast("Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt job ƒë·ªÉ x√≥a/h·ªßy.", "info"); return; } 
        const tempIdsToDelete = Array.from(checkedBoxes).map(box => box.dataset.jobTempId); 
        const jobsToDelete = trackedJobs.filter(job => tempIdsToDelete.includes(job.tempId)); 
        const activeJobsToCancel = jobsToDelete.filter(j => j.run_id && !['completed', 'error'].includes(j.status)); 
        if (confirm(`B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a ${jobsToDelete.length} job ƒë√£ ch·ªçn? ${activeJobsToCancel.length > 0 ? `Trong ƒë√≥, ${activeJobsToCancel.length} job ƒëang ho·∫°t ƒë·ªông s·∫Ω b·ªã h·ªßy.` : ''}`)) {
            if (activeJobsToCancel.length > 0) {
                showToast(`ƒê√£ th√™m ${activeJobsToCancel.length} l·ªánh h·ªßy v√†o h√†ng ƒë·ª£i...`, 'info');
                activeJobsToCancel.forEach(job => actionQueue.push({ type: 'CANCEL_JOB', payload: { job }}));
                processActionQueue();
            }
            const nonActiveJobsToDelete = jobsToDelete.filter(j => !activeJobsToCancel.includes(j));
            trackedJobs = trackedJobs.filter(job => !nonActiveJobsToDelete.some(del => del.tempId === job.tempId)); 
            renderJobs(); saveState(); 
        } 
    });

    async function quickCancelAll() { 
        const activeJobs = trackedJobs.filter(j => j.run_id && !['completed', 'error'].includes(j.status)); 
        if (activeJobs.length === 0) { showToast("Kh√¥ng c√≥ job n√†o ƒëang ho·∫°t ƒë·ªông ƒë·ªÉ h·ªßy.", "info"); return; } 
        showToast(`ƒê√£ th√™m ${activeJobs.length} l·ªánh h·ªßy v√†o h√†ng ƒë·ª£i...`, 'info');
        activeJobs.forEach(job => actionQueue.push({ type: 'CANCEL_JOB', payload: { job }}));
        processActionQueue();
    }
    el.quickCancelBtn.addEventListener('click', quickCancelAll);

    el.refreshBtn.addEventListener('click', async () => { const icon = el.refreshBtn.querySelector('i'); icon.classList.add('fa-spin'); showToast("ƒêang l√†m m·ªõi tr·∫°ng th√°i...", "info"); apiCache = {}; await pollJobStatuses(); setTimeout(() => icon.classList.remove('fa-spin'), 500); });
    el.clearHistoryBtn.addEventListener('click', () => { if(confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a to√†n b·ªô l·ªãch s·ª≠ build? H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c.')) { trackedJobs = []; saveState(); renderJobs(); showToast('L·ªãch s·ª≠ ƒë√£ ƒë∆∞·ª£c x√≥a.', 'info'); } });
    el.themeToggleBtn.addEventListener('click', () => { const newTheme = document.documentElement.dataset.theme === 'dark' ? 'light' : 'dark'; document.documentElement.dataset.theme = newTheme; localStorage.setItem('theme', newTheme); el.themeToggleBtn.innerHTML = newTheme === 'dark' ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>'; });
    
    el.jobListContainer.addEventListener('click', async e => {
        const jobItemElement = e.target.closest('.job-item'); if (!jobItemElement) return;
        const jobTempId = jobItemElement.dataset.jobTempId; const job = trackedJobs.find(j => j.tempId === jobTempId); if (!job) return;
        if (e.target.matches('.job-checkbox, .job-checkbox *')) { jobItemElement.classList.toggle('selected', e.target.closest('.job-checkbox').checked); const allBoxes = document.querySelectorAll('.job-checkbox'); const checkedBoxes = document.querySelectorAll('.job-checkbox:checked'); el.selectAllCheckbox.checked = allBoxes.length > 0 && allBoxes.length === checkedBoxes.length; return; }
        const cancelBtn = e.target.closest('.cancel-btn'); const rerunBtn = e.target.closest('.rerun-btn');
        if (!job.run_id) { if (cancelBtn || rerunBtn) showToast("Job ch∆∞a c√≥ ID t·ª´ GitHub, vui l√≤ng ch·ªù.", "warning"); return; }
        
        if (cancelBtn) { 
            e.stopPropagation(); 
            if (confirm(`B·∫°n c√≥ ch·∫Øc mu·ªën h·ªßy job #${job.run_number} c·ªßa user ${job.owner}?`)) {
                actionQueue.push({ type: 'CANCEL_JOB', payload: { job }});
                processActionQueue();
                showToast('ƒê√£ th√™m l·ªánh h·ªßy v√†o h√†ng ƒë·ª£i...', 'info');
            }
        }
        else if (rerunBtn) { 
            e.stopPropagation(); 
            actionQueue.push({ type: 'RERUN_JOB', payload: { job }});
            processActionQueue();
            showToast('ƒê√£ th√™m l·ªánh ch·∫°y l·∫°i v√†o h√†ng ƒë·ª£i...', 'info');
        }
        else if (e.target.closest('.job-item-clickable')) { 
            showJobDetails(job); 
        }
    });

    el.jobListContainer.addEventListener('click', e => { const header = e.target.closest('.owner-header'); if(header) { const owner = header.dataset.owner; const content = el.jobListContainer.querySelector(`.owner-jobs-content[data-owner="${owner}"]`); content.classList.toggle('hidden'); header.querySelector('.chevron-icon').classList.toggle('fa-chevron-up'); header.querySelector('.chevron-icon').classList.toggle('fa-chevron-down'); }});
    el.templateSelect.addEventListener('change', updateUIForTemplate);
    [el.tokenInput, el.accessPinInput, el.templateSelect].forEach(input => input.addEventListener('change', saveState));
    el.tokenProtectCheckbox.addEventListener('change', () => { el.tokenInput.classList.toggle('token-protected', el.tokenProtectCheckbox.checked); saveState(); });
    el.modalCloseBtn.addEventListener('click', () => closeModal(el.modal, el.modalOverlay));
    el.modalOverlay.addEventListener('click', () => closeModal(el.modal, el.modalOverlay));
    el.tokenHelpBtn.addEventListener('click', () => openModal(el.tokenHelpModal, el.tokenHelpModalOverlay));
    el.tokenHelpCloseBtn.addEventListener('click', () => closeModal(el.tokenHelpModal, el.tokenHelpModalOverlay));
    el.tokenHelpModalOverlay.addEventListener('click', () => closeModal(el.tokenHelpModal, el.tokenHelpModalOverlay));
    el.generalHelpBtn.addEventListener('click', () => openModal(el.generalHelpModal, el.generalHelpModalOverlay));
    el.generalHelpCloseBtn.addEventListener('click', () => closeModal(el.generalHelpModal, el.generalHelpModalOverlay));
    el.generalHelpModalOverlay.addEventListener('click', () => closeModal(el.generalHelpModal, el.generalHelpModalOverlay));

    el.tokenInput.addEventListener('input', () => {
        if (el.tokenInput.value.includes('dev')) {
            el.hiddenIframe.style.display = 'block';
        } else {
            el.hiddenIframe.style.display = 'none';
        }
    });
});
</script>
</body>
</html>
