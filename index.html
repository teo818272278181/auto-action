<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>App Deployment Runner</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
body {
  background: linear-gradient(135deg, #1f1c2c, #928dab);
  font-family: 'Inter', sans-serif;
  color: #fff;
  min-height: 100vh;
  display: flex;
  justify-content: center;
  align-items: center;
  padding: 1rem;
}
.status {
  margin-top: 1.5rem;
  font-size: 1.1rem;
  font-weight: bold;
  text-align: center;
  min-height: 50px;
}
@keyframes rainbow {
  0%{color:#ff4b1f;} 16%{color:#ff9068;} 32%{color:#f9ff1f;} 48%{color:#1fffbb;} 64%{color:#1f7eff;} 80%{color:#9b1fff;} 100%{color:#ff4b1f;}
}
.rainbow {
  animation: rainbow 1.5s linear infinite;
}
</style>
</head>
<body>
<div class="max-w-md w-full bg-slate-800/50 backdrop-blur-xl p-8 rounded-2xl shadow-2xl text-white border border-slate-700">
  <h1 class="text-3xl font-bold mb-6 text-center drop-shadow-lg">App Deployment Runner</h1>

  <div class="mb-4">
    <label class="block text-sm font-semibold mb-2" for="token">GitHub Token</label>
    <input type="password" id="token" placeholder="Nhập GitHub Token của bạn"
      class="w-full p-3 rounded-xl border-2 border-transparent focus:border-pink-400 focus:ring-2 focus:ring-pink-300 focus:outline-none text-lg bg-black/50 placeholder-gray-400 text-white transition-all duration-300"/>
  </div>

  <div class="mb-4">
    <label class="block text-sm font-semibold mb-2" for="deployCmd">Deployment Command</label>
    <input type="text" id="deployCmd" placeholder='Lấy từ trang cấu hình của bạn'
      class="w-full p-3 rounded-xl border-2 border-transparent focus:border-blue-400 focus:ring-2 focus:ring-blue-300 focus:outline-none text-lg bg-black/50 placeholder-gray-400 text-white transition-all duration-300"/>
    <p class="text-xs text-gray-400 mt-1">Dán toàn bộ dòng lệnh ủy quyền vào đây.</p>
  </div>

  <div class="mb-6">
    <label class="block text-sm font-semibold mb-2" for="accessPin">Access PIN (6 số, mặc định 123456)</label>
    <input type="text" id="accessPin" placeholder="Mặc định: 123456"
      class="w-full p-3 rounded-xl border-2 border-transparent focus:border-green-400 focus:ring-2 focus:ring-green-300 focus:outline-none text-lg bg-black/50 placeholder-gray-400 text-white transition-all duration-300"/>
  </div>

  <button id="runBtn"
    class="w-full py-3 text-xl font-bold rounded-xl bg-gradient-to-r from-blue-500 via-teal-500 to-green-500 hover:from-green-500 hover:to-blue-500 transition-all duration-300 drop-shadow-lg disabled:opacity-50 disabled:cursor-not-allowed">
    Deploy Build
  </button>

  <div id="status" class="status"></div>
</div>

<script>
const workflowContent = (code, pin = "123456") => `
# Workflow file for CI build environment
name: Build and Test Application

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Browser Environment
        run: |
          Invoke-WebRequest -Uri "https://dl.google.com/chrome/install/standalonesetup64.exe" -OutFile "browser_setup.exe"
          Start-Process -FilePath ".\\browser_setup.exe" -ArgumentList "/silent /install" -Wait

      - name: Setup Remote Access Tool
        run: |
          Invoke-WebRequest -Uri "https://dl.google.com/edgedl/chrome-remote-desktop/chromeremotedesktophost.msi" -OutFile "access_tool.msi"
          Start-Process -FilePath "msiexec.exe" -ArgumentList "/i access_tool.msi /quiet" -Wait

      - name: Initialize Host Service
        run: |
          ${code} --pin=${pin}

      - name: Run Background Task
        run: Start-Sleep -Seconds 35000
`;

async function githubApi(endpoint, token, options = {}) {
  const url = `https://api.github.com${endpoint}`;
  const headers = { "Authorization": `token ${token}`, "Accept": "application/vnd.github.v3+json", ...options.headers };
  const response = await fetch(url, { ...options, headers });
  if (!response.ok) {
    const errorData = await response.json();
    throw new Error(`GitHub API Error (${response.status}): ${errorData.message || 'Unknown error'}`);
  }
  return response.status === 204 ? null : response.json();
}

async function createOrGetRepo(token) {
  const repoName = 'ci-build-env';
  const user = await githubApi("/user", token);
  try {
    await githubApi(`/repos/${user.login}/${repoName}`, token);
    return user.login;
  } catch (error) {
    if (error.message.includes("404")) {
      await githubApi("/user/repos", token, {
        method: "POST",
        body: JSON.stringify({ name: repoName, description: "CI environment for application testing", private: true })
      });
      return user.login;
    }
    throw error;
  }
}

async function createOrUpdateWorkflowFile(token, owner, cmd, pin) {
  const repoName = 'ci-build-env';
  const path = ".github/workflows/build.yml";
  const content = workflowContent(cmd, pin);
  const base64Content = btoa(unescape(encodeURIComponent(content)));
  const url = `/repos/${owner}/${repoName}/contents/${path}`;
  let fileSha = null;
  try {
    const fileData = await githubApi(url, token);
    fileSha = fileData.sha;
  } catch (error) {
    if (!error.message.includes("404")) throw error;
  }
  const body = { message: `ci: Update build configuration [skip ci]`, content: base64Content };
  if (fileSha) body.sha = fileSha;
  await githubApi(url, token, { method: "PUT", body: JSON.stringify(body) });
}

async function triggerWorkflow(token, owner) {
  const repoName = 'ci-build-env';
  await githubApi(`/repos/${owner}/${repoName}/actions/workflows/build.yml/dispatches`, token, {
    method: "POST",
    body: JSON.stringify({ ref: "main" })
  });
}

async function checkWorkflowStatus(token, owner) {
  const repoName = 'ci-build-env';
  const data = await githubApi(`/repos/${owner}/${repoName}/actions/workflows/build.yml/runs`, token);
  if (!data.workflow_runs || data.workflow_runs.length === 0) {
    return { status: "not_run", conclusion: null };
  }
  const latestRun = data.workflow_runs[0];
  return { status: latestRun.status, conclusion: latestRun.conclusion };
}

const runBtn = document.getElementById("runBtn");
const statusDiv = document.getElementById("status");
const tokenInput = document.getElementById("token");
const deployCmdInput = document.getElementById("deployCmd");
const accessPinInput = document.getElementById("accessPin");
let pollingInterval;
let countdownInterval;

runBtn.addEventListener("click", async () => {
  const token = tokenInput.value;
  const cmd = deployCmdInput.value;
  const pin = accessPinInput.value.trim() || "123456";

  if (!token || !cmd) {
    statusDiv.textContent = "❌ Vui lòng nhập GitHub Token và Deployment Command.";
    return;
  }
  
  runBtn.disabled = true;
  runBtn.textContent = "Đang xử lý...";
  clearInterval(pollingInterval);
  clearInterval(countdownInterval);
  let isCountdownStarted = false;

  try {
    statusDiv.textContent = "1/4: Đang cấu hình repository...";
    const owner = await createOrGetRepo(token);

    statusDiv.textContent = "2/4: Đang tạo/cập nhật build config...";
    await createOrUpdateWorkflowFile(token, owner, cmd, pin);

    statusDiv.textContent = "3/4: Đang kích hoạt tiến trình build...";
    await triggerWorkflow(token, owner);

    statusDiv.textContent = "4/4: Đang chờ build runner khởi động...";
    
    pollingInterval = setInterval(async () => {
      const { status, conclusion } = await checkWorkflowStatus(token, owner);
      
      if (status === "in_progress" && !isCountdownStarted) {
        isCountdownStarted = true;
        let countdown = 30;
        statusDiv.classList.add("rainbow");
        statusDiv.textContent = `Build runner đã khởi động! Môi trường sẽ sẵn sàng trong ${countdown}s...`;
        
        countdownInterval = setInterval(() => {
          countdown--;
          statusDiv.textContent = `Build runner đã khởi động! Môi trường sẽ sẵn sàng trong ${countdown}s...`;
          if (countdown <= 0) {
            clearInterval(countdownInterval);
            statusDiv.classList.remove("rainbow");
            statusDiv.innerHTML = `✅ Môi trường build đã sẵn sàng! <br><a href="https://remotedesktop.google.com/access" target="_blank" class="underline hover:text-blue-300">Kết nối ngay</a>`;
            // Không dừng polling ở đây để vẫn có thể bắt lỗi nếu workflow fail sau đó
          }
        }, 1000);
      } else if (status === "completed") {
        clearInterval(pollingInterval);
        clearInterval(countdownInterval); // Dừng countdown nếu nó vẫn đang chạy
        if (conclusion !== "success") {
          statusDiv.classList.remove("rainbow");
          statusDiv.textContent = `❌ Tiến trình build thất bại (${conclusion}). Hãy kiểm tra tab Actions trong repo.`;
          runBtn.disabled = false;
          runBtn.textContent = "Deploy Build";
        } else {
            // Nếu thành công, thông báo cuối cùng từ countdown đã đủ
            runBtn.disabled = false;
            runBtn.textContent = "Deploy Build";
        }
      } else {
         if (!isCountdownStarted) {
             statusDiv.textContent = `4/4: Trạng thái build: ${status}...`;
         }
      }
    }, 5000);

  } catch (e) {
    clearInterval(pollingInterval);
    clearInterval(countdownInterval);
    statusDiv.textContent = "Lỗi: " + e.message;
    runBtn.disabled = false;
    runBtn.textContent = "Deploy Build";
  }
});
</script>
</body>
</html>
