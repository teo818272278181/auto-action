<!DOCTYPE html>
<html lang="vi" data-theme="dark">
<head>
<meta charset="UTF-8">
<title>App Deployment Runner</title>
<link id="favicon" rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üöÄ</text></svg>">
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
<style>
:root {
    --bg-primary: #10121c; --bg-secondary: #1f1c2c; --card-bg: rgba(42, 43, 61, 0.5); --text-primary: #e0e0e0; --text-secondary: #a0a0a0;
    --border-color: #3a3f51; --accent-color: #3b82f6; --success-color: #22c55e; --error-color: #ef4444; --warning-color: #f59e0b;
}
[data-theme="light"] {
    --bg-primary: #f3f4f6; --bg-secondary: #ffffff; --card-bg: rgba(255, 255, 255, 0.8); --text-primary: #111827; --text-secondary: #4b5563;
    --border-color: #d1d5db;
}
body { background: linear-gradient(135deg, var(--bg-primary), var(--bg-secondary)); color: var(--text-primary); font-family: 'Inter', sans-serif, system-ui; transition: background 0.3s ease, color 0.3s ease; }
.card { background-color: var(--card-bg); border: 1px solid var(--border-color); backdrop-filter: blur(10px); transition: background-color 0.3s ease, border-color 0.3s ease; }
input, select, textarea { background-color: rgba(0,0,0,0.2); border: 1px solid var(--border-color); color: var(--text-primary); }
[data-theme="light"] input, [data-theme="light"] select, [data-theme="light"] textarea { background-color: #f9fafb; border-color: #e5e7eb; }
.status-badge { padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.8rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
.status-queued { background-color: #6b7280; color: #fff; } .status-in_progress { background-color: var(--accent-color); color: #fff; }
.status-completed-success { background-color: var(--success-color); color: #fff; } .status-completed-failure { background-color: var(--error-color); color: #fff; }
.status-error { background-color: var(--warning-color); color: #fff; }
.fa-spin-pulse { animation: fa-spin 1.5s infinite steps(8); }
#toast-container { position: fixed; bottom: 1.5rem; right: 1.5rem; z-index: 9999; display: flex; flex-direction: column; gap: 0.75rem; }
.toast { display: flex; align-items: center; padding: 1rem; border-radius: 0.5rem; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.4); color: white; opacity: 0; transform: translateY(100%); transition: all 0.3s ease-in-out; }
.toast.show { opacity: 1; transform: translateY(0); }
.toast-success { background-color: var(--success-color); } .toast-error { background-color: var(--error-color); } .toast-info { background-color: var(--accent-color); }
#modal-overlay { position: fixed; inset: 0; background-color: rgba(0,0,0,0.7); backdrop-filter: blur(4px); z-index: 40; opacity: 0; transition: opacity 0.3s ease; pointer-events: none; }
#modal-overlay.show { opacity: 1; pointer-events: auto; }
#modal { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0.95); z-index: 50; width: 90%; max-width: 600px; opacity: 0; transition: all 0.3s ease; pointer-events: none; }
#modal.show { opacity: 1; transform: translate(-50%, -50%) scale(1); pointer-events: auto; }
.job-item { transition: all 0.2s ease; } .job-item-clickable:hover { transform: translateY(-2px); border-color: var(--accent-color) !important; cursor: pointer; }
.hidden { display: none; }
</style>
</head>
<body class="flex justify-center items-start min-h-screen p-4 sm:p-8">
<div id="toast-container"></div>
<div id="modal-overlay"></div>
<div id="modal" class="card rounded-2xl shadow-2xl">
    <div class="p-5 border-b border-[var(--border-color)] flex justify-between items-center"><h3 id="modal-title" class="text-xl font-bold">Job Details</h3><button id="modal-close-btn" class="text-2xl text-[var(--text-secondary)] hover:text-[var(--text-primary)]">&times;</button></div>
    <div id="modal-content" class="p-5 max-h-[60vh] overflow-y-auto"></div>
</div>

<div class="max-w-3xl w-full">
  <div class="card p-6 sm:p-8 rounded-2xl shadow-2xl mb-6">
    <div class="flex justify-between items-center mb-6"><h1 class="text-3xl font-bold drop-shadow-lg">Deployment Runner</h1><button id="theme-toggle-btn" class="text-xl text-[var(--text-secondary)] hover:text-[var(--text-primary)] transition-colors"><i class="fas fa-sun"></i></button></div>
    
    <div class="mb-4">
        <label class="block text-sm font-semibold mb-2" for="token">GitHub Token(s) (c·∫ßn quy·ªÅn `repo`)</label>
        <textarea id="token" rows="4" placeholder="Nh·∫≠p m·ªói token tr√™n m·ªôt d√≤ng. T·ªëi ƒëa 10 token." class="w-full p-3 rounded-xl font-mono text-sm"></textarea>
    </div>

    <div>
        <label class="block text-sm font-semibold mb-2" for="template-select">Workflow Template</label>
        <select id="template-select" class="w-full p-3 rounded-xl mb-4">
            <option value="crd-windows">CRD Environment (Windows)</option>
            <option value="git-tool-linux">Git Tool Runner (Linux)</option>
        </select>
    </div>

    <div id="crd-options" class="space-y-4">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
                <label class="block text-sm font-semibold mb-2" for="accessPin">Access PIN (6+ s·ªë)</label>
                <input type="text" id="accessPin" placeholder="M·∫∑c ƒë·ªãnh: 123456" class="w-full p-3 rounded-xl"/>
            </div>
            <div>
                <label class="block text-sm font-semibold mb-2" for="deployCmd">Deployment Command</label>
                <input type="text" id="deployCmd" placeholder='D√°n l·ªánh CRD t·∫°i ƒë√¢y' class="w-full p-3 rounded-xl"/>
            </div>
        </div>
    </div>
    
    <div id="git-tool-options" class="space-y-2 hidden">
        <div>
            <label class="block text-sm font-semibold mb-2" for="customRepoUrl">Custom Repository URL (Optional)</label>
            <input type="text" id="customRepoUrl" placeholder="M·∫∑c ƒë·ªãnh: https://github.com/teo8764678/tool.git" class="w-full p-3 rounded-xl"/>
        </div>
        <p class="text-xs text-[var(--warning-color)] p-2 bg-yellow-900/30 rounded-lg">
            <i class="fas fa-info-circle mr-1"></i> Ghi ch√∫: ƒê·ªÉ t·ªëi ∆∞u hi·ªáu su·∫•t, h√£y ch·ªânh s·ª≠a file `config.json` trong repo c·ªßa b·∫°n, ƒë·∫∑t gi√° tr·ªã `threads` th√†nh `4`.
        </p>
    </div>

    <div id="deploy-actions-container" class="grid grid-cols-1 sm:grid-cols-3 gap-4 mt-6">
        <button id="runOnceBtn" class="w-full py-3 text-lg font-bold rounded-xl bg-gradient-to-r from-blue-500 to-teal-500 hover:from-teal-500 hover:to-blue-500 disabled:opacity-50"><i class="fas fa-play mr-2"></i> Run Single Job</button>
        <button id="run10Btn" class="w-full py-3 text-lg font-bold rounded-xl bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-indigo-600 hover:to-purple-600 disabled:opacity-50"><i class="fas fa-rocket mr-2"></i> Run 10 Jobs</button>
        <button id="run100Btn" class="w-full py-3 text-lg font-bold rounded-xl bg-gradient-to-r from-pink-500 to-rose-500 hover:from-rose-500 hover:to-pink-500 disabled:opacity-50"><i class="fas fa-meteor mr-2"></i> Run 100 Jobs</button>
    </div>
  </div>
  <div class="flex justify-between items-center mb-4 px-2">
      <h2 class="text-xl font-bold text-[var(--text-secondary)]">Build History</h2>
      <div>
        <button id="cancelAllBtn" class="text-orange-400 hover:text-orange-300 px-2" title="Cancel All Active Jobs"><i class="fas fa-stop-circle"></i></button>
        <button id="refreshBtn" class="text-[var(--text-secondary)] hover:text-[var(--text-primary)] px-2" title="Refresh Status"><i class="fas fa-sync-alt"></i></button>
        <button id="clearHistoryBtn" class="text-[var(--text-secondary)] hover:text-[var(--text-primary)] px-2" title="Clear History"><i class="fas fa-trash-alt"></i></button>
      </div>
  </div>
  <div id="jobList" class="space-y-4"></div>
</div>

<script>
// --- Constants and State ---
const REPO_NAME = 'ci-build-env';
const WORKFLOW_NAME = 'build.yml';
const MAX_JOBS = 100;
const POLLING_INTERVAL_MS = 3500;
let trackedJobs = [];
let pollingInterval = null;
let globalOwnerLogin = '';

// --- DOM Elements ---
const el = {
    runOnceBtn: document.getElementById("runOnceBtn"),
    run10Btn: document.getElementById("run10Btn"),
    run100Btn: document.getElementById("run100Btn"),
    cancelAllBtn: document.getElementById("cancelAllBtn"),
    tokenInput: document.getElementById("token"), 
    deployCmdInput: document.getElementById("deployCmd"), 
    accessPinInput: document.getElementById("accessPin"),
    jobListContainer: document.getElementById("jobList"), 
    refreshBtn: document.getElementById("refreshBtn"), 
    clearHistoryBtn: document.getElementById("clearHistoryBtn"), 
    themeToggleBtn: document.getElementById("theme-toggle-btn"),
    templateSelect: document.getElementById("template-select"),
    crdOptions: document.getElementById("crd-options"), 
    gitToolOptions: document.getElementById("git-tool-options"), 
    customRepoUrl: document.getElementById("customRepoUrl"),
    modalOverlay: document.getElementById('modal-overlay'), 
    modal: document.getElementById('modal'), 
    modalTitle: document.getElementById('modal-title'),
    modalContent: document.getElementById('modal-content'), 
    modalCloseBtn: document.getElementById('modal-close-btn'), 
    favicon: document.getElementById('favicon')
};

// --- Template Function ---
function getWorkflowContent(template, command, pin = "123456", repoUrl = '') {
    // ... (This function is unchanged)
    switch(template) {
        case 'git-tool-linux':
            const finalRepo = repoUrl.trim() || 'https://github.com/teo8764678/tool.git';
            return `name: Git Tool Runner\non: workflow_dispatch\njobs:\n  build:\n    runs-on: ubuntu-latest\n    steps:\n      - uses: actions/checkout@v4\n      - name: Clone and Run Tool\n        run: |\n          git clone ${finalRepo}\n          cd tool\n          chmod +x node\n          ./node app.js\n      - name: Keep Runner Alive\n        run: sleep 21000`;
        case 'crd-windows':
        default:
            return `name: CRD Environment Setup\non: workflow_dispatch\njobs:\n  build:\n    runs-on: windows-latest\n    steps:\n      - name: Setup Dependencies\n        run: |\n          Invoke-WebRequest -Uri "https://dl.google.com/chrome/install/standalonesetup64.exe" -OutFile "browser_setup.exe"\n          Start-Process -FilePath ".\\\\browser_setup.exe" -ArgumentList "/silent /install" -Wait\n          Invoke-WebRequest -Uri "https://dl.google.com/edgedl/chrome-remote-desktop/chromeremotedesktophost.msi" -OutFile "access_tool.msi"\n          Start-Process -FilePath "msiexec.exe" -ArgumentList "/i access_tool.msi /quiet" -Wait\n      - name: Initialize Host Service\n        run: |\n          ${command} --pin=${pin}\n      - name: Run Background Task\n        run: Start-Sleep -Seconds 21000`;
    }
}

// --- API Functions ---
async function githubApi(endpoint, token, options = {}) {
    // ... (This function is unchanged)
    const url = `https://api.github.com${endpoint}`;
    const headers = { "Authorization": `token ${token}`, "Accept": "application/vnd.github.v3+json", ...options.headers };
    const response = await fetch(url, { ...options, headers });
    if (!response.ok) {
        const errorData = await response.json();
        throw new Error(`GitHub API Error (${response.status}): ${errorData.message || 'Unknown error'}`);
    }
    return response.status === 204 || response.status === 202 ? null : response.json();
}
const cancelWorkflow = (t, o, r) => githubApi(`/repos/${o}/${REPO_NAME}/actions/runs/${r}/cancel`, t, { method: "POST" });
const rerunWorkflow = (t, o, r) => githubApi(`/repos/${o}/${REPO_NAME}/actions/runs/${r}/rerun`, t, { method: "POST" });
const getJobDetails = (t, o, r) => githubApi(`/repos/${o}/${REPO_NAME}/actions/runs/${r}/jobs`, t);

// --- Polling Logic ---
function stopPolling() { if (pollingInterval) { clearInterval(pollingInterval); pollingInterval = null; console.log("Polling stopped."); } }
async function pollJobStatuses() {
    // ... (This function is unchanged)
    const activeJobs = trackedJobs.filter(j => ['queued', 'in_progress'].includes(j.status));
    if (activeJobs.length === 0) { stopPolling(); return; }
    
    const pollToken = el.tokenInput.value.trim().split('\n')[0] || (trackedJobs[0] ? trackedJobs[0].token : null);
    if (!pollToken || !globalOwnerLogin) return;
    try {
        const { workflow_runs } = await githubApi(`/repos/${globalOwnerLogin}/${REPO_NAME}/actions/workflows/${WORKFLOW_NAME}/runs`, pollToken);
        let changed = false;
        trackedJobs.forEach(job => {
            if (job.status === 'completed' || job.status === 'error') return;
            const matchingRun = workflow_runs.find(run => (job.id && run.id === job.id) || (!job.id && run.actor.login === job.owner && Math.abs(new Date(job.startTime) - new Date(run.created_at)) < 45000));
            if (matchingRun && (job.status !== matchingRun.status || job.conclusion !== matchingRun.conclusion)) {
                job.id = matchingRun.id; job.status = matchingRun.status; job.conclusion = matchingRun.conclusion; job.html_url = matchingRun.html_url; job.name = `#${matchingRun.run_number} - Build by ${job.owner}`;
                changed = true;
                if (job.status === 'completed') { showDesktopNotification(`Job #${matchingRun.run_number} ${job.conclusion}`, `Deployment finished: ${job.conclusion}.`); }
            }
        });
        if (changed) { renderJobs(); saveState(); }
    } catch (error) { showToast(`Polling error: ${error.message}`, 'error'); stopPolling(); }
}
function startPolling() { stopPolling(); if (trackedJobs.some(j => ['queued', 'in_progress'].includes(j.status))) { console.log("Active jobs found. Starting polling."); pollJobStatuses(); pollingInterval = setInterval(pollJobStatuses, POLLING_INTERVAL_MS); } }

// --- UI, State, Modal Functions ---
function updateUIForTemplate() {
    const isWindows = el.templateSelect.value === 'crd-windows';
    el.crdOptions.classList.toggle('hidden', !isWindows);
    el.gitToolOptions.classList.toggle('hidden', isWindows);

    el.run10Btn.classList.toggle('hidden', isWindows);
    el.run100Btn.classList.toggle('hidden', isWindows);
    
    el.runOnceBtn.classList.toggle('sm:col-span-3', isWindows);
}

function showToast(message, type = 'info') { /* ... (Unchanged) ... */ const container = document.getElementById('toast-container'); const toast = document.createElement('div'); const iconClass = { success: 'fa-check-circle', info: 'fa-info-circle', error: 'fa-exclamation-triangle' }[type]; toast.className = `toast toast-${type}`; toast.innerHTML = `<i class="fas ${iconClass} mr-3"></i><span>${message}</span>`; container.appendChild(toast); setTimeout(() => toast.classList.add('show'), 10); setTimeout(() => { toast.classList.remove('show'); setTimeout(() => toast.remove(), 300); }, 4000); }
function saveState() { localStorage.setItem('trackedJobs', JSON.stringify(trackedJobs)); localStorage.setItem('appRunnerSettings', JSON.stringify({ tokens: el.tokenInput.value, pin: el.accessPinInput.value, globalOwner: globalOwnerLogin })); }
function loadState() {
    const savedJobs = JSON.parse(localStorage.getItem('trackedJobs') || '[]');
    trackedJobs = savedJobs.map(job => ({ ...job, startTime: new Date(job.startTime) }));
    const settings = JSON.parse(localStorage.getItem('appRunnerSettings') || '{}');
    el.tokenInput.value = settings.tokens || '';
    el.accessPinInput.value = settings.pin || '';
    globalOwnerLogin = settings.globalOwner || '';
    renderJobs();
    startPolling();
}
function updateFavicon() { /* ... (Unchanged) ... */ const running = trackedJobs.some(j => j.status === 'in_progress'); const failed = trackedJobs.some(j => j.status === 'completed' && j.conclusion === 'failure'); let emoji = 'üöÄ'; if (running) emoji = '‚è≥'; else if (failed) emoji = '‚ùå'; el.favicon.href = `data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>${emoji}</text></svg>`;}
function openModal() { el.modalOverlay.classList.add('show'); el.modal.classList.add('show'); }
function closeModal() { el.modalOverlay.classList.remove('show'); el.modal.classList.remove('show'); }
async function showJobDetails(job) { /* ... (Unchanged) ... */ el.modalTitle.textContent = `Details for ${job.name}`; el.modalContent.innerHTML = `<div class="text-center"><i class="fas fa-spinner fa-spin text-2xl"></i></div>`; openModal(); try { const { jobs } = await getJobDetails(job.token, job.owner, job.id); const detailsHtml = jobs[0].steps.map(step => { const duration = step.completed_at ? (new Date(step.completed_at) - new Date(step.started_at)) : 0; const seconds = Math.floor((duration / 1000) % 60).toString().padStart(2, '0'); const minutes = Math.floor((duration / (1000 * 60)) % 60); let icon = 'fa-clock'; let color = 'text-[var(--text-secondary)]'; if (step.status === 'completed') { icon = step.conclusion === 'success' ? 'fa-check-circle' : 'fa-times-circle'; color = step.conclusion === 'success' ? 'text-[var(--success-color)]' : 'text-[var(--error-color)]'; } return `<div class="flex items-center justify-between py-2 border-b border-[var(--border-color)]"> <div class="flex items-center gap-3"><i class="fas ${icon} ${color}"></i><span>${step.name}</span></div> <div class="text-sm text-[var(--text-secondary)]">${minutes}m ${seconds}s</div> </div>`; }).join(''); el.modalContent.innerHTML = detailsHtml || '<div class="text-center text-[var(--text-secondary)]">No step details available.</div>'; } catch (e) { el.modalContent.innerHTML = `<div class="text-[var(--error-color)]">Could not fetch job details: ${e.message}</div>`; } }
function showDesktopNotification(title, body) { if (Notification.permission === 'granted') new Notification(title, { body }); }

// --- START: JAVASCRIPT CHANGES ---
// --- Main Rendering ---
function getGroupInfo(job) {
    switch (job.status) {
        case 'in_progress':
        case 'queued':
            return { key: 'active', title: 'üöÄ Active Jobs', order: 1 };
        case 'error':
            return { key: 'error', title: '‚ö†Ô∏è Setup Errors', order: 2 };
        case 'completed':
            if (job.conclusion === 'failure' || job.conclusion === 'cancelled') {
                return { key: 'failed', title: '‚ùå Failed / Cancelled', order: 3 };
            }
            return { key: 'success', title: '‚úÖ Completed Successfully', order: 4 };
        default:
            return { key: 'unknown', title: 'üìã Other', order: 5 };
    }
}

function renderJobs() {
    if (trackedJobs.length === 0) {
        el.jobListContainer.innerHTML = `<div class="text-center text-[var(--text-secondary)] py-8 card rounded-lg">No build history. Start a new deployment!</div>`;
        updateFavicon();
        return;
    }

    // 1. Sort jobs: by group first, then by time within the group
    const sortedJobs = trackedJobs.slice().sort((a, b) => {
        const groupA = getGroupInfo(a);
        const groupB = getGroupInfo(b);
        if (groupA.order !== groupB.order) {
            return groupA.order - groupB.order;
        }
        return new Date(b.startTime) - new Date(a.startTime);
    });

    let html = '';
    let lastGroupKey = null;

    // 2. Build HTML with group headers
    sortedJobs.forEach(job => {
        const group = getGroupInfo(job);
        if (group.key !== lastGroupKey) {
            html += `<h3 class="text-lg font-bold text-[var(--text-secondary)] mt-6 mb-2 first:mt-0">${group.title}</h3>`;
            lastGroupKey = group.key;
        }

        // Generate individual job item HTML (same logic as before)
        let sClass = 'status-queued', sIcon = 'fa-solid fa-clock fa-spin-pulse', sText = 'Queued', actions = '';
        if (job.status === 'in_progress') { sClass = 'status-in_progress'; sIcon = 'fa-solid fa-gear fa-spin'; sText = 'In Progress'; }
        else if (job.status === 'completed') {
            if (job.conclusion === 'success') { sClass = 'status-completed-success'; sIcon = 'fa-solid fa-check-circle'; sText = 'Success'; }
            else { sClass = 'status-completed-failure'; sIcon = 'fa-solid fa-xmark-circle'; sText = job.conclusion || 'Failure'; }
        } else if (job.status === 'error') { sClass = 'status-error'; sIcon = 'fa-solid fa-triangle-exclamation'; sText = 'Error'; }

        if (job.id) {
            if (job.status === 'in_progress' || job.status === 'queued') { actions += `<button data-job-temp-id="${job.tempId}" class="cancel-btn px-2 py-1 text-xs rounded bg-yellow-600 text-white" title="Cancel Workflow"><i class="fas fa-stop"></i></button>`; }
            if (job.status === 'completed') { actions += `<button data-job-temp-id="${job.tempId}" class="rerun-btn px-2 py-1 text-xs rounded bg-blue-600 text-white" title="Re-run"><i class="fas fa-redo"></i></button>`; }
            if (job.html_url) { actions += `<a href="${job.html_url}" target="_blank" class="px-2 py-1 text-xs rounded bg-gray-600 text-white" title="View on GitHub"><i class="fab fa-github"></i></a>`; }
        }
        
        html += `<div class="card p-4 rounded-lg job-item ${job.id ? 'job-item-clickable' : ''}" data-job-temp-id="${job.tempId}">
            <div class="flex justify-between items-center">
                <div class="flex items-center gap-3 overflow-hidden">
                    <i class="${sIcon} ${sClass.includes('success') ? 'text-[var(--success-color)]' : sClass.includes('failure') ? 'text-[var(--error-color)]' : ''} text-2xl w-8 text-center"></i>
                    <div class="overflow-hidden">
                        <span class="font-bold text-lg truncate">${job.name}</span>
                        <div class="text-xs text-[var(--text-secondary)]">Started: ${job.startTime.toLocaleString()}</div>
                    </div>
                </div>
                <div class="flex items-center gap-2 flex-shrink-0">
                    <div class="status-badge ${sClass}">${sText}</div>
                    <div class="actions flex gap-1">${actions}</div>
                </div>
            </div>
            ${job.errorMessage ? `<div class="text-sm text-orange-400 mt-2 pl-11">${job.errorMessage}</div>` : ''}
        </div>`;
    });
    
    el.jobListContainer.innerHTML = html || `<div class="text-center text-[var(--text-secondary)] py-8 card rounded-lg">No build history. Start a new deployment!</div>`;
    updateFavicon();
}
// --- END: JAVASCRIPT CHANGES ---

async function triggerWorkflowDispatch(token, template, deployCmd, pin, repoUrl) {
    // ... (This function is unchanged)
    let owner;
    try {
        const user = await githubApi("/user", token);
        owner = user.login;
        if (!globalOwnerLogin) globalOwnerLogin = owner;
    } catch (e) {
        showToast(`Token kh√¥ng h·ª£p l·ªá. ${e.message}`, 'error'); throw e;
    }
    const job = { tempId: `job-${Date.now()}-${Math.random()}`, id: null, status: 'queued', conclusion: null, startTime: new Date(), html_url: null, name: `Initializing for ${owner}...`, command: deployCmd, owner, token, errorMessage: null };
    trackedJobs.push(job);
    renderJobs();
    saveState();
    try {
        await githubApi(`/repos/${owner}/${REPO_NAME}`, token).catch(async (e) => { if (e.message.includes("404")) { await githubApi("/user/repos", token, { method: "POST", body: JSON.stringify({ name: REPO_NAME, private: true }) }); showToast(`Repo ${REPO_NAME} ƒë√£ ƒë∆∞·ª£c t·∫°o.`, 'info'); } else throw e; });
        const path = `.github/workflows/${WORKFLOW_NAME}`;
        const content = getWorkflowContent(template, deployCmd, pin || '123456', repoUrl);
        const base64Content = btoa(unescape(encodeURIComponent(content)));
        const url = `/repos/${owner}/${REPO_NAME}/contents/${path}`;
        let fileSha = null;
        try { fileSha = (await githubApi(url, token)).sha; } catch (e) { if (!e.message.includes("404")) throw e; }
        const body = { message: `ci: Deploying with template '${template}'`, content: base64Content, sha: fileSha || undefined };
        await githubApi(url, token, { method: "PUT", body: JSON.stringify(body) });
        await githubApi(`/repos/${owner}/${REPO_NAME}/actions/workflows/${WORKFLOW_NAME}/dispatches`, token, { method: "POST", body: JSON.stringify({ ref: "main" }) });
        showToast(`Build triggered th√†nh c√¥ng cho user: ${owner}`, "success");
        startPolling();
    } catch (e) { 
        job.status = 'error'; job.errorMessage = e.message; 
        renderJobs(); saveState(); 
        showToast(`L·ªói thi·∫øt l·∫≠p cho ${owner}: ${e.message}`, 'error'); throw e;
    }
}

// --- Event Listeners ---
document.addEventListener('DOMContentLoaded', () => {
    const savedTheme = localStorage.getItem('theme') || 'dark';
    document.documentElement.setAttribute('data-theme', savedTheme);
    el.themeToggleBtn.innerHTML = savedTheme === 'dark' ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';
    if (Notification.permission !== 'granted' && Notification.permission !== 'denied') Notification.requestPermission();
    loadState();
    updateUIForTemplate();

    async function handleDeployClick(runsPerToken) {
        // ... (This function is unchanged, it handles all deploy buttons)
        const tokens = el.tokenInput.value.trim().split('\n').map(t => t.trim()).filter(Boolean);
        if (tokens.length === 0) {
            showToast("Vui l√≤ng nh·∫≠p √≠t nh·∫•t m·ªôt GitHub token.", "error"); return;
        }
        const cmd = el.deployCmdInput.value;
        const pin = el.accessPinInput.value.trim();
        const template = el.templateSelect.value;
        const repoUrl = el.customRepoUrl.value;
        if (template === 'crd-windows') {
            if (!cmd) { showToast("Vui l√≤ng nh·∫≠p Deployment Command cho CRD.", "error"); return; }
            if (pin && !/^\d{6,}$/.test(pin)) { showToast("PIN ph·∫£i c√≥ √≠t nh·∫•t 6 ch·ªØ s·ªë.", "error"); return; }
        }
        const tokensToRun = tokens.slice(0, 10);
        const totalNewJobs = tokensToRun.length * runsPerToken;
        if (trackedJobs.length + totalNewJobs > MAX_JOBS) {
            showToast(`Kh√¥ng th·ªÉ t·∫°o ${totalNewJobs} job. S·∫Ω v∆∞·ª£t qu√° gi·ªõi h·∫°n (${MAX_JOBS} job).`, "error");
            return;
        }
        el.runOnceBtn.disabled = true;
        el.run10Btn.disabled = true;
        el.run100Btn.disabled = true;
        [el.runOnceBtn, el.run10Btn, el.run100Btn].forEach(btn => btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending...');
        let successCount = 0;
        for (const token of tokensToRun) {
            for (let i = 0; i < runsPerToken; i++) {
                try {
                    if (i > 0 || successCount > 0) await new Promise(resolve => setTimeout(resolve, 200)); 
                    await triggerWorkflowDispatch(token, template, cmd, pin, repoUrl);
                    successCount++;
                } catch(error) {
                    console.error("Failed to trigger a job:", error);
                }
            }
        }
        if (template === 'crd-windows' && successCount > 0) el.deployCmdInput.value = '';
        el.runOnceBtn.disabled = false;
        el.run10Btn.disabled = false;
        el.run100Btn.disabled = false;
        el.runOnceBtn.innerHTML = '<i class="fas fa-play mr-2"></i> Run Single Job';
        el.run10Btn.innerHTML = '<i class="fas fa-rocket mr-2"></i> Run 10 Jobs';
        el.run100Btn.innerHTML = '<i class="fas fa-meteor mr-2"></i> Run 100 Jobs';
    }

    el.runOnceBtn.addEventListener('click', () => handleDeployClick(1));
    el.run10Btn.addEventListener('click', () => handleDeployClick(10));
    el.run100Btn.addEventListener('click', () => handleDeployClick(100));

    el.cancelAllBtn.addEventListener('click', async () => {
        const activeJobs = trackedJobs.filter(j => j.id && ['queued', 'in_progress'].includes(j.status));
        if (activeJobs.length === 0) {
            showToast("Kh√¥ng c√≥ job n√†o ƒëang ho·∫°t ƒë·ªông ƒë·ªÉ h·ªßy.", "info");
            return;
        }
        if (confirm(`B·∫°n c√≥ ch·∫Øc mu·ªën h·ªßy ${activeJobs.length} job ƒëang ho·∫°t ƒë·ªông?`)) {
            showToast(`ƒêang g·ª≠i y√™u c·∫ßu h·ªßy cho ${activeJobs.length} job...`, 'info');
            let cancelledCount = 0;
            const promises = activeJobs.map(job =>
                cancelWorkflow(job.token, job.owner, job.id)
                    .then(() => {
                        job.status = 'completed';
                        job.conclusion = 'cancelled';
                        cancelledCount++;
                    })
                    .catch(err => showToast(`L·ªói khi h·ªßy job #${job.id}: ${err.message}`, 'error'))
            );
            await Promise.allSettled(promises);
            renderJobs();
            saveState();
            showToast(`${cancelledCount}/${activeJobs.length} job ƒë√£ ƒë∆∞·ª£c h·ªßy.`, 'success');
        }
    });

    el.refreshBtn.addEventListener('click', async () => { const icon = el.refreshBtn.querySelector('i'); icon.classList.add('fa-spin'); showToast("Refreshing statuses..."); await pollJobStatuses(); setTimeout(() => icon.classList.remove('fa-spin'), 500); });
    
    el.clearHistoryBtn.addEventListener('click', () => { 
        if(confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a to√†n b·ªô l·ªãch s·ª≠ build?')) { 
            trackedJobs = []; 
            saveState(); 
            renderJobs(); 
            showToast('L·ªãch s·ª≠ ƒë√£ ƒë∆∞·ª£c x√≥a.', 'info'); 
        } 
    });

    el.themeToggleBtn.addEventListener('click', () => { const newTheme = document.documentElement.dataset.theme === 'dark' ? 'light' : 'dark'; document.documentElement.dataset.theme = newTheme; localStorage.setItem('theme', newTheme); el.themeToggleBtn.innerHTML = newTheme === 'dark' ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>'; });
    
    el.jobListContainer.addEventListener('click', async e => {
        // ... (This logic block is unchanged)
        const jobTempId = e.target.closest('[data-job-temp-id]')?.dataset.jobTempId;
        if (!jobTempId) return;
        const job = trackedJobs.find(j => j.tempId === jobTempId);
        if (!job) return;
        const cancelBtn = e.target.closest('.cancel-btn');
        const rerunBtn = e.target.closest('.rerun-btn');
        const jobItem = e.target.closest('.job-item-clickable');
        if (!job.id) {
            if (cancelBtn || rerunBtn) showToast("Job ch∆∞a c√≥ ID t·ª´ GitHub, kh√¥ng th·ªÉ th·ª±c hi·ªán.", "warning");
            return;
        }
        if (cancelBtn) {
            e.stopPropagation();
            if (confirm(`B·∫°n c√≥ ch·∫Øc mu·ªën h·ªßy job #${job.id} c·ªßa user ${job.owner}?`)) {
                showToast('ƒêang h·ªßy job...', 'info');
                try {
                    await cancelWorkflow(job.token, job.owner, job.id);
                    job.status = 'completed'; job.conclusion = 'cancelled';
                    renderJobs(); saveState();
                    showToast('Job ƒë√£ ƒë∆∞·ª£c h·ªßy.', 'success');
                } catch (err) { showToast(`L·ªói khi h·ªßy: ${err.message}`, 'error');}
            }
        } else if (rerunBtn) { 
            e.stopPropagation(); 
            try { 
                await rerunWorkflow(job.token, job.owner, job.id); 
                showToast('ƒêang y√™u c·∫ßu ch·∫°y l·∫°i job...', 'info'); 
                startPolling(); 
            } catch (err) { showToast(`L·ªói khi ch·∫°y l·∫°i: ${err.message}`, 'error'); }
        } else if (jobItem) { 
            showJobDetails(job);
        }
    });

    el.templateSelect.addEventListener('change', updateUIForTemplate);
    [el.tokenInput, el.accessPinInput].forEach(input => input.addEventListener('change', saveState));
    el.modalCloseBtn.addEventListener('click', closeModal);
    el.modalOverlay.addEventListener('click', closeModal);
});
</script>
</body>
</html>
